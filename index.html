<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Wave</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%230a0a1f'/%3E%3Crect x='15' y='55' width='10' height='30' rx='5' fill='%23667eea'/%3E%3Crect x='30' y='35' width='10' height='50' rx='5' fill='%23764ba2'/%3E%3Crect x='45' y='20' width='10' height='65' rx='5' fill='%23667eea'/%3E%3Crect x='60' y='35' width='10' height='50' rx='5' fill='%23764ba2'/%3E%3Crect x='75' y='50' width='10' height='35' rx='5' fill='%23667eea'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%230a0a1f'/%3E%3Crect x='15' y='55' width='10' height='30' rx='5' fill='%23667eea'/%3E%3Crect x='30' y='35' width='10' height='50' rx='5' fill='%23764ba2'/%3E%3Crect x='45' y='20' width='10' height='65' rx='5' fill='%23667eea'/%3E%3Crect x='60' y='35' width='10' height='50' rx='5' fill='%23764ba2'/%3E%3Crect x='75' y='50' width='10' height='35' rx='5' fill='%23667eea'/%3E%3C/svg%3E">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Music Wave">
    <meta name="application-name" content="Music Wave">
    <meta name="theme-color" content="#0a0a1f">
    <style>
        html {
            background: #0a0a1f;
            margin: 0;
            padding: 0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            height: 100vh;
            position: relative;
            background: #0a0a1f;
            margin: 0;
            padding: 0;
        }

        /* Animated Starry Night Background */
        .wallpaper-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: linear-gradient(to bottom, #0a0a1f 0%, #1a0a2e 50%, #0f0520 100%);
            overflow: hidden;
        }

        /* Stars Layer */
        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, white, transparent),
                radial-gradient(2px 2px at 60px 70px, white, transparent),
                radial-gradient(1px 1px at 50px 50px, white, transparent),
                radial-gradient(1px 1px at 130px 80px, white, transparent),
                radial-gradient(2px 2px at 90px 10px, white, transparent);
            background-repeat: repeat;
            background-size: 200px 200px;
            animation: twinkle 3s infinite;
        }

        .stars:after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(1px 1px at 40px 60px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 100px 20px, rgba(255,255,255,0.6), transparent),
                radial-gradient(2px 2px at 150px 90px, rgba(255,255,255,0.9), transparent),
                radial-gradient(1px 1px at 80px 120px, rgba(255,255,255,0.7), transparent);
            background-repeat: repeat;
            background-size: 250px 250px;
            animation: twinkle 4s infinite reverse;
        }

        @keyframes twinkle {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.3;
            }
        }

        /* Shooting Stars */
        .shooting-star {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, #fff, transparent);
            animation: shoot 3s linear infinite;
            opacity: 0;
        }

        .shooting-star:nth-child(1) {
            top: 20%;
            left: 0;
            width: 100px;
            animation-delay: 0s;
        }

        .shooting-star:nth-child(2) {
            top: 40%;
            left: 0;
            width: 80px;
            animation-delay: 4s;
        }

        .shooting-star:nth-child(3) {
            top: 60%;
            left: 0;
            width: 90px;
            animation-delay: 8s;
        }

        @keyframes shoot {
            0% {
                transform: translateX(0) translateY(0);
                opacity: 1;
            }
            70% {
                opacity: 1;
            }
            100% {
                transform: translateX(1000px) translateY(500px);
                opacity: 0;
            }
        }

        /* Moon */
        .moon {
            position: absolute;
            top: 10%;
            right: 10%;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff, #e8e8e8);
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.4);
            animation: moonGlow 5s infinite alternate;
        }

        @keyframes moonGlow {
            0% {
                box-shadow: 0 0 40px rgba(255, 255, 255, 0.4);
            }
            100% {
                box-shadow: 0 0 60px rgba(255, 255, 255, 0.6);
            }
        }

        /* Overlay for better text visibility */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0,0,0,0.3), rgba(0,0,0,0.5));
            z-index: 1;
            pointer-events: none;
        }

        /* Content Container */
        .content {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: white;
            text-align: center;
            padding: 20px;
        }

        h1 {
            font-size: 4rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 20px rgba(0,0,0,0.8);
            animation: fadeInDown 1s ease-out;
        }

        .subtitle {
            font-size: 1.5rem;
            margin-bottom: 3rem;
            text-shadow: 1px 1px 10px rgba(0,0,0,0.8);
            animation: fadeInUp 1s ease-out 0.3s both;
        }

        /* Music Control Panel */
        .music-control {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 20px 40px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            animation: fadeInUp 1s ease-out 0.6s both;
            z-index: 100;
            pointer-events: auto;
        }

        .play-pause-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            pointer-events: auto;
            z-index: 101;
        }

        .play-pause-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .play-pause-btn:active {
            transform: scale(0.95);
        }

        .play-pause-btn svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .song-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            color: white;
            text-shadow: 1px 1px 5px rgba(0,0,0,0.5);
        }

        .song-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .song-status {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        /* Search Bar */
        .search-section {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            width: 500px;
            max-width: 90vw;
            animation: fadeIn 1s ease-out 0.5s both;
        }

        .search-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            width: 100%;
            padding: 14px 55px 14px 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.25);
            border-radius: 50px;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .search-input:focus {
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
        }

        .search-btn {
            position: absolute;
            right: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.5);
        }

        /* Search Results Dropdown */
        .search-results {
            position: absolute;
            top: calc(100% + 10px);
            left: 0;
            right: 0;
            background: rgba(15, 5, 32, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 200;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 14px 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.07);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .result-thumbnail {
            width: 55px;
            height: 55px;
            border-radius: 10px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .result-info {
            flex: 1;
            min-width: 0;
        }

        .result-title {
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .result-channel {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            margin-top: 4px;
        }

        .result-play-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .result-play-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.5);
        }

        .search-loading {
            padding: 20px;
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .search-no-results {
            padding: 20px;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
        }

        /* Now Playing from YouTube */
        .yt-player {
            display: none;
        }

        /* Upload Section */
        .upload-section {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 100;
            animation: fadeIn 1s ease-out 0.9s both;
        }

        .upload-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-block;
        }

        .upload-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        input[type="file"] {
            display: none;
        }

        /* Animations */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* ===== RESPONSIVE DESIGN - MOBILE FIRST ===== */
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .subtitle {
                font-size: 1rem;
                padding: 0 10px;
            }

            /* Content moves down to avoid overlap with top bar */
            .content {
                padding-top: 180px;
                justify-content: flex-start;
                padding-bottom: 160px;
            }

            /* Search bar - full width on mobile, pushed down from top */
            .search-section {
                top: 90px !important;
                left: 10px !important;
                right: 10px !important;
                transform: none !important;
                width: auto !important;
                max-width: none !important;
            }

            /* Upload section - LEFT side on mobile, above music player */
            .upload-section {
                top: auto !important;
                bottom: 140px;
                left: 10px;
                right: auto;
                display: flex;
                flex-direction: column;
                gap: 5px;
                align-items: flex-start;
            }

            .upload-btn {
                padding: 8px 14px;
                font-size: 0.75rem;
            }

            /* Music control - wider on mobile, more padding bottom */
            .music-control {
                padding: 12px 18px;
                bottom: 65px;
                gap: 12px;
                width: calc(100% - 20px);
                left: 10px;
                right: 10px;
                transform: none;
                border-radius: 20px;
            }

            .play-pause-btn {
                width: 48px;
                height: 48px;
                flex-shrink: 0;
            }

            .song-title {
                font-size: 0.85rem;
                max-width: 180px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .song-status {
                font-size: 0.75rem;
            }

            /* Auth trigger button - smaller on mobile */
            .auth-trigger {
                top: 15px !important;
                left: 10px !important;
                padding: 9px 16px !important;
                font-size: 0.82rem !important;
            }

            /* User profile bar - compact on mobile */
            .user-profile {
                top: 10px !important;
                left: 10px !important;
                right: 10px !important;
                padding: 7px 12px !important;
                gap: 8px !important;
                flex-wrap: nowrap;
                overflow-x: auto;
            }

            .user-avatar {
                width: 34px !important;
                height: 34px !important;
                font-size: 1rem !important;
                flex-shrink: 0;
            }

            .user-name {
                font-size: 0.85rem !important;
                flex-shrink: 1;
                min-width: 0;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .my-profile-btn {
                padding: 6px 10px !important;
                font-size: 0.72rem !important;
                white-space: nowrap;
                flex-shrink: 0;
            }

            .logout-btn {
                padding: 6px 10px !important;
                font-size: 0.72rem !important;
                white-space: nowrap;
                flex-shrink: 0;
            }

            /* Owner button - smaller */
            .owner-btn {
                bottom: 15px;
                left: 10px;
                padding: 7px 12px;
                font-size: 0.75rem;
            }

            /* Owner panel - full width */
            .owner-panel {
                bottom: 55px;
                left: 10px;
                right: 10px;
                width: auto;
            }

            /* Credit footer - RIGHT side, above music player, no overlap */
            .credit {
                font-size: 0.72rem;
                bottom: 150px !important;
                right: 10px !important;
                left: auto !important;
                top: auto !important;
                text-align: right;
                background: rgba(0,0,0,0.5);
                backdrop-filter: blur(10px);
                padding: 8px 14px;
                border-radius: 12px;
                border: 1px solid rgba(255,215,0,0.25);
                z-index: 60;
                max-width: 55%;
            }

            .credit strong {
                font-size: 0.88rem;
                letter-spacing: 1px;
            }

            .whatsapp-link {
                font-size: 0.73rem;
            }

            /* Moon - moved well below the search bar area */
            .moon {
                width: 45px;
                height: 45px;
                top: 22%;
                right: 8%;
                opacity: 0.7;
            }

            /* Search results full width */
            .search-results {
                max-height: 250px;
            }
        }

        /* Extra small screens (phones < 380px) */
        @media (max-width: 380px) {
            h1 { font-size: 1.6rem; }
            .subtitle { font-size: 0.85rem; }

            .user-profile {
                padding: 5px 8px !important;
                gap: 6px !important;
            }

            .my-profile-btn { display: none !important; }

            .song-title { max-width: 130px; }

            .music-control {
                padding: 10px 12px;
            }
        }

        /* Loading indicator */
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            padding: 20px 40px;
            border-radius: 10px;
            color: white;
            font-size: 1.1rem;
            z-index: 1000;
        }

        .loading.active {
            display: block;
        }

        /* Credit - Bottom Right Golden Signature (No Box) */
        .credit {
            position: fixed;
            bottom: 130px;
            right: 30px;
            z-index: 50;
            text-align: right;
            animation: fadeIn 2s ease-out 1.5s both;
        }

        .credit strong {
            background: linear-gradient(135deg, #FFD700, #FFA500, #FFD700, #FFED4E);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.3rem;
            font-weight: 900;
            letter-spacing: 3px;
            text-transform: uppercase;
            animation: goldShine 4s ease-in-out infinite;
            text-shadow: 
                0 0 20px rgba(255, 215, 0, 0.9),
                0 0 35px rgba(255, 215, 0, 0.6),
                0 0 50px rgba(255, 215, 0, 0.4);
            font-family: 'Georgia', 'Times New Roman', serif;
            display: block;
        }

        .credit {
            color: rgba(255, 240, 200, 0.95);
            font-size: 0.95rem;
            font-weight: 700;
            letter-spacing: 1.5px;
            text-shadow: 
                0 0 12px rgba(255, 215, 0, 0.5),
                0 0 20px rgba(255, 215, 0, 0.3);
            font-family: 'Georgia', 'Times New Roman', serif;
        }

        .credit::before {
            content: '✨ ';
            font-size: 1rem;
            animation: sparkle 2s ease-in-out infinite;
        }

        .credit::after {
            content: ' ✨';
            font-size: 1rem;
            animation: sparkle 2s ease-in-out infinite 1s;
        }

        .whatsapp-link {
            display: block;
            margin-top: 8px;
            color: rgba(37, 211, 102, 1);
            background: linear-gradient(135deg, #25D366, #128C7E);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            animation: whatsappGlow 3s ease-in-out infinite;
            text-shadow: 
                0 0 12px rgba(37, 211, 102, 0.6),
                0 0 20px rgba(37, 211, 102, 0.4);
            transition: all 0.3s ease;
        }

        .whatsapp-link:hover {
            transform: scale(1.05);
            text-shadow: 
                0 0 20px rgba(37, 211, 102, 0.9),
                0 0 35px rgba(37, 211, 102, 0.6);
        }

        @keyframes whatsappGlow {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        @keyframes sparkle {
            0%, 100% {
                opacity: 1;
                text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
            }
            50% {
                opacity: 0.6;
                text-shadow: 0 0 20px rgba(255, 215, 0, 1);
            }
        }

        @keyframes goldShine {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        @keyframes goldenGlow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.3), 0 0 40px rgba(255, 215, 0, 0.1);
            }
            50% {
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.5), 0 0 60px rgba(255, 215, 0, 0.2);
            }
        }

        .credit a {
            color: rgba(255, 215, 0, 0.9);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .credit a:hover {
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        /* DJ Avatar Visualizer */
        .dj-avatar {
            position: fixed;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 200px;
            z-index: 20;
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }

        .dj-avatar.active {
            opacity: 1;
        }

        .dj-avatar img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 30px rgba(255, 105, 180, 0.5));
        }

        /* DJ Animation when playing */
        .dj-avatar.playing {
            animation: djBounceTop 0.6s ease-in-out infinite;
        }

        @keyframes djBounceTop {
            0%, 100% {
                transform: translateX(-50%) scale(1) rotate(0deg);
            }
            25% {
                transform: translateX(-50%) scale(1.05) rotate(-2deg);
            }
            75% {
                transform: translateX(-50%) scale(1.05) rotate(2deg);
            }
        }

        /* Glow pulse effect */
        .dj-avatar.playing img {
            animation: glowPulse 1.5s ease-in-out infinite;
        }

        @keyframes glowPulse {
            0%, 100% {
                filter: drop-shadow(0 0 30px rgba(255, 105, 180, 0.5));
            }
            50% {
                filter: drop-shadow(0 0 50px rgba(255, 105, 180, 0.9)) 
                        drop-shadow(0 0 80px rgba(138, 43, 226, 0.7));
            }
        }

        /* Audio waves around DJ */
        .audio-wave {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border: 3px solid rgba(255, 105, 180, 0.3);
            border-radius: 50%;
            opacity: 0;
        }

        .dj-avatar.playing .audio-wave {
            animation: waveExpand 2s ease-out infinite;
        }

        .audio-wave:nth-child(2) {
            animation-delay: 0.5s;
        }

        .audio-wave:nth-child(3) {
            animation-delay: 1s;
        }

        @keyframes waveExpand {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
            50% {
                opacity: 0.6;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.3);
                opacity: 0;
            }
        }

        @media (max-width: 768px) {
            .dj-avatar {
                width: 120px;
                height: 120px;
                top: 155px;
            }

            .audio-wave {
                width: 150px;
                height: 150px;
            }

            .credit {
                font-size: 0.72rem;
                bottom: 10px;
                padding: 8px 14px;
            }
            
            .credit strong {
                font-size: 0.85rem;
            }
        }

        /* Authentication System */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .auth-modal.active {
            display: flex;
        }

        .auth-container {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            backdrop-filter: blur(30px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            padding: 45px;
            width: 90%;
            max-width: 420px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.7);
            position: relative;
        }

        .auth-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 35px;
        }

        .auth-tab {
            flex: 1;
            padding: 14px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.05rem;
            font-weight: 700;
        }

        .auth-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 6px 18px rgba(102, 126, 234, 0.5);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 22px;
        }

        .form-group label {
            display: block;
            color: white;
            margin-bottom: 10px;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.25);
            border-radius: 12px;
            color: white;
            font-size: 1.05rem;
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
        }

        .auth-submit {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.15rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.3s ease;
        }

        .auth-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.5);
        }

        .close-auth {
            position: absolute;
            top: 22px;
            right: 22px;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            color: white;
            font-size: 1.6rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-auth:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(90deg);
        }

        .user-profile {
            position: fixed;
            top: 32px;
            left: 32px;
            z-index: 150;
            display: none;
            align-items: center;
            gap: 16px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            padding: 11px 22px;
            border-radius: 55px;
            border: 2px solid rgba(255, 255, 255, 0.25);
        }

        .user-profile.active {
            display: flex;
        }

        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.25rem;
        }

        .user-name {
            color: white;
            font-weight: 700;
            font-size: 1.05rem;
        }

        .logout-btn {
            background: rgba(255, 59, 48, 0.6);
            border: none;
            padding: 9px 17px;
            border-radius: 22px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 59, 48, 0.8);
        }

        .auth-trigger {
            position: fixed;
            top: 32px;
            left: 32px;
            z-index: 150;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            padding: 13px 28px;
            border-radius: 28px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 6px 17px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }

        .auth-trigger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 22px rgba(102, 126, 234, 0.6);
        }

        .auth-trigger.hidden {
            display: none;
        }

        /* Search Bar */
        .search-section {
            position: fixed;
            top: 28px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 150;
            width: 380px;
            max-width: 55vw;
        }

        .search-wrapper {
            display: flex;
            gap: 8px;
            align-items: center;
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(15px);
            border: 1.5px solid rgba(255, 255, 255, 0.2);
            border-radius: 40px;
            padding: 5px 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .search-wrapper:focus-within {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .search-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: white;
            font-size: 0.85rem;
            padding: 5px 4px;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.82rem;
        }

        .search-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 40px;
            padding: 7px 14px;
            color: white;
            cursor: pointer;
            font-size: 0.82rem;
            font-weight: 700;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .search-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }

        /* Search Results */
        .search-results {
            margin-top: 10px;
            background: rgba(10, 10, 31, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            max-height: 350px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5);
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255,255,255,0.07);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .result-thumb {
            width: 55px;
            height: 55px;
            border-radius: 10px;
            object-fit: cover;
            flex-shrink: 0;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .result-info {
            flex: 1;
            overflow: hidden;
        }

        .result-title {
            color: white;
            font-weight: 700;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .result-channel {
            color: rgba(255,255,255,0.5);
            font-size: 0.82rem;
            margin-top: 4px;
        }

        .result-play-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .result-play-btn:hover {
            transform: scale(1.15);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.5);
        }

        .search-loading {
            text-align: center;
            padding: 20px;
            color: rgba(255,255,255,0.6);
            font-size: 0.95rem;
        }

        /* YouTube Player Hidden */
        #yt-player {
            display: none;
        }

        /* Now Playing from YouTube */
        .yt-now-playing {
            display: none;
            align-items: center;
            gap: 10px;
        }

        .yt-now-playing.active {
            display: flex;
        }

        .yt-thumb {
            width: 45px;
            height: 45px;
            border-radius: 8px;
            object-fit: cover;
        }

        /* Autocomplete Suggestions */
        .suggestions-box {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            right: 0;
            background: rgba(10, 10, 31, 0.97);
            backdrop-filter: blur(20px);
            border: 1.5px solid rgba(102, 126, 234, 0.4);
            border-radius: 15px;
            overflow: hidden;
            display: none;
            z-index: 200;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .suggestions-box.active {
            display: block;
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            color: white;
            font-size: 0.88rem;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover,
        .suggestion-item.selected {
            background: rgba(102, 126, 234, 0.25);
        }

        .suggestion-icon {
            font-size: 1rem;
            opacity: 0.7;
        }

        .suggestion-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .suggestion-arrow {
            opacity: 0.4;
            font-size: 0.8rem;
        }

        .search-section {
            position: relative;
        }

        /* Scrollbar for suggestions */
        .suggestions-box::-webkit-scrollbar {
            width: 4px;
        }
        .suggestions-box::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 4px;
        }

        /* ===== OWNER PANEL ===== */
        .owner-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 500;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: none;
            padding: 9px 16px;
            border-radius: 30px;
            color: #1a0a00;
            font-weight: 900;
            font-size: 0.82rem;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255,215,0,0.4);
            letter-spacing: 1px;
            transition: all 0.3s;
        }
        .owner-btn:hover {
            transform: scale(1.07);
            box-shadow: 0 0 25px rgba(255,215,0,0.8);
        }

        /* Owner Code Panel - Search bar style drop panel */
        .owner-panel {
            position: fixed;
            bottom: 60px;
            left: 20px;
            z-index: 2000;
            width: 320px;
            display: none;
            flex-direction: column;
            gap: 0;
        }
        .owner-panel.active { display: flex; }

        /* Code input box - like search bar */
        .owner-code-box {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(10, 10, 31, 0.97);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255,215,0,0.5);
            border-radius: 50px;
            padding: 7px 12px;
            box-shadow: 0 8px 32px rgba(255,215,0,0.2);
        }
        .owner-code-box:focus-within {
            border-color: #FFD700;
            box-shadow: 0 8px 32px rgba(255,215,0,0.4);
        }

        .owner-code-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: #FFD700;
            font-size: 0.9rem;
            padding: 5px 4px;
            letter-spacing: 2px;
        }
        .owner-code-input::placeholder {
            color: rgba(255,215,0,0.35);
            letter-spacing: 1px;
            font-size: 0.82rem;
        }

        .owner-unlock-btn {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: none;
            border-radius: 40px;
            padding: 7px 14px;
            color: #1a0a00;
            font-weight: 900;
            font-size: 0.82rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }
        .owner-unlock-btn:hover { transform: scale(1.05); }

        .owner-error {
            color: #ff6b6b;
            font-size: 0.8rem;
            padding: 6px 15px;
            display: none;
        }
        .owner-error.show { display: block; }

        /* Owner Dashboard - drops down like search results */
        .owner-dashboard {
            display: none;
            background: rgba(10, 10, 31, 0.97);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255,215,0,0.3);
            border-radius: 20px;
            padding: 20px;
            margin-top: 8px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
        }
        .owner-dashboard.active { display: block; }

        .owner-login-form { display: flex; flex-direction: column; }
        .owner-login-form.hidden { display: none; }

        .owner-dash-title {
            font-size: 1.1rem;
            font-weight: 900;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,215,0,0.15);
            border-radius: 12px;
            padding: 14px 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.7rem;
            font-weight: 900;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: rgba(255,255,255,0.5);
            font-size: 0.75rem;
            margin-top: 4px;
        }

        .owner-dash-btns {
            display: flex;
            gap: 8px;
        }

        .owner-logout {
            flex: 1;
            background: rgba(255,59,48,0.15);
            border: 1px solid rgba(255,59,48,0.35);
            border-radius: 10px;
            color: #ff6b6b;
            padding: 9px;
            cursor: pointer;
            font-size: 0.82rem;
            transition: all 0.3s;
        }
        .owner-logout:hover { background: rgba(255,59,48,0.35); }

        .owner-close-dash {
            flex: 1;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            color: rgba(255,255,255,0.5);
            padding: 9px;
            cursor: pointer;
            font-size: 0.82rem;
            transition: all 0.3s;
        }
        .owner-close-dash:hover { border-color: white; color: white; }

        /* ===== MY PROFILE BUTTON ===== */
        .my-profile-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            padding: 9px 17px;
            border-radius: 22px;
            color: white;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        .my-profile-btn:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(102,126,234,0.5); }

        .profile-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(12px);
            z-index: 5000;
            align-items: center;
            justify-content: center;
        }
        .profile-modal.active { display: flex; }
        .profile-box {
            background: linear-gradient(145deg, #0d0d2b, #1a0a2e);
            border: 2px solid rgba(102,126,234,0.4);
            border-radius: 28px;
            padding: 35px 30px;
            width: 420px;
            max-width: 94vw;
            max-height: 88vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 60px rgba(0,0,0,0.7);
        }
        .profile-box::-webkit-scrollbar { width: 4px; }
        .profile-box::-webkit-scrollbar-thumb { background: rgba(102,126,234,0.4); border-radius: 4px; }
        .profile-close {
            position: absolute; top: 16px; right: 20px;
            background: rgba(255,255,255,0.08); border: none;
            width: 36px; height: 36px; border-radius: 50%;
            color: white; font-size: 1.3rem; cursor: pointer; transition: all 0.2s;
        }
        .profile-close:hover { background: rgba(255,59,48,0.5); }
        .profile-header { text-align: center; margin-bottom: 25px; }
        .profile-avatar-wrap { position: relative; display: inline-block; margin-bottom: 14px; }
        .profile-avatar-display {
            width: 90px; height: 90px; border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex; align-items: center; justify-content: center;
            font-size: 2.2rem; color: white; font-weight: 900;
            border: 3px solid rgba(102,126,234,0.5);
            overflow: hidden; cursor: pointer; transition: all 0.3s; margin: 0 auto;
        }
        .profile-avatar-display:hover { transform: scale(1.05); }
        .profile-avatar-display img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
        .profile-avatar-badge {
            position: absolute; bottom: 2px; right: 2px;
            background: #667eea; border-radius: 50%;
            width: 26px; height: 26px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.75rem; border: 2px solid #0d0d2b;
        }
        .profile-username { font-size: 1.3rem; font-weight: 900; color: white; margin-bottom: 4px; }
        .profile-email    { color: rgba(255,255,255,0.45); font-size: 0.85rem; }
        .profile-section-title {
            font-size: 0.78rem; font-weight: 700;
            color: rgba(255,255,255,0.45); text-transform: uppercase;
            letter-spacing: 1.5px; margin: 20px 0 10px;
        }
        .logo-presets {
            display: grid; grid-template-columns: repeat(8,1fr);
            gap: 8px; margin-bottom: 5px;
        }
        .logo-preset {
            aspect-ratio: 1; border-radius: 12px;
            background: rgba(255,255,255,0.06);
            border: 2px solid transparent;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.4rem; cursor: pointer; transition: all 0.2s;
        }
        .logo-preset:hover { background: rgba(102,126,234,0.2); border-color: rgba(102,126,234,0.5); transform: scale(1.1); }
        .logo-preset.selected { background: rgba(102,126,234,0.3); border-color: #667eea; transform: scale(1.1); }
        .profile-upload-area {
            border: 2px dashed rgba(102,126,234,0.35); border-radius: 16px;
            padding: 20px; text-align: center; cursor: pointer;
            transition: all 0.3s; background: rgba(102,126,234,0.04);
        }
        .profile-upload-area:hover { border-color: #667eea; background: rgba(102,126,234,0.1); }
        .upload-icon  { font-size: 1.8rem; margin-bottom: 6px; }
        .upload-text  { color: rgba(255,255,255,0.7); font-size: 0.9rem; font-weight: 600; }
        .upload-sub   { color: rgba(255,255,255,0.35); font-size: 0.75rem; margin-top: 4px; }
        .profile-name-row { display: flex; gap: 10px; }
        .profile-name-input {
            flex: 1; padding: 11px 16px;
            background: rgba(255,255,255,0.07);
            border: 1.5px solid rgba(102,126,234,0.3);
            border-radius: 12px; color: white; font-size: 0.92rem;
            outline: none; transition: border-color 0.2s;
        }
        .profile-name-input:focus { border-color: #667eea; }
        .profile-name-input::placeholder { color: rgba(255,255,255,0.3); }
        .profile-save-btn {
            padding: 11px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none; border-radius: 12px; color: white;
            font-weight: 700; font-size: 0.88rem; cursor: pointer;
            transition: all 0.3s; white-space: nowrap;
        }
        .profile-save-btn:hover { transform: scale(1.03); box-shadow: 0 4px 15px rgba(102,126,234,0.4); }

    

        /* ===== LIVE CHAT + EMOJI ===== */
        /* ===== LIVE CHAT ===== */
        .chat-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 500;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            width: 54px;
            height: 54px;
            border-radius: 50%;
            color: white;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102,126,234,0.5);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-toggle-btn:hover { transform: scale(1.1); box-shadow: 0 6px 25px rgba(102,126,234,0.7); }
        .chat-toggle-btn .chat-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #ff4757;
            color: white;
            font-size: 0.6rem;
            font-weight: 900;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .chat-toggle-btn .chat-badge.show { display: flex; }

        .chat-window {
            position: fixed;
            bottom: 85px;
            right: 20px;
            z-index: 490;
            width: 320px;
            max-width: calc(100vw - 40px);
            height: 420px;
            background: rgba(8, 8, 25, 0.97);
            backdrop-filter: blur(25px);
            border: 2px solid rgba(102,126,234,0.35);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7), 0 0 40px rgba(102,126,234,0.15);
            transform: scale(0.85) translateY(20px);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .chat-window.active {
            transform: scale(1) translateY(0);
            opacity: 1;
            pointer-events: all;
        }

        .chat-header {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        .chat-header-dot {
            width: 9px;
            height: 9px;
            border-radius: 50%;
            background: #2ed573;
            box-shadow: 0 0 8px #2ed573;
            animation: livePulse 2s infinite;
            flex-shrink: 0;
        }
        @keyframes livePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .chat-header-title {
            flex: 1;
            color: white;
            font-size: 0.9rem;
            font-weight: 700;
        }
        .chat-header-sub {
            color: rgba(255,255,255,0.35);
            font-size: 0.7rem;
            margin-top: 2px;
        }
        .chat-close-btn {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.4);
            font-size: 1rem;
            cursor: pointer;
            padding: 4px;
            transition: color 0.2s;
        }
        .chat-close-btn:hover { color: white; }

        /* Username prompt */
        .chat-name-prompt {
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
            justify-content: center;
        }
        .chat-name-prompt p {
            color: rgba(255,255,255,0.7);
            font-size: 0.85rem;
            text-align: center;
        }
        .chat-name-input {
            background: rgba(255,255,255,0.07);
            border: 1.5px solid rgba(102,126,234,0.4);
            border-radius: 10px;
            color: white;
            font-size: 0.9rem;
            padding: 10px 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        .chat-name-input:focus { border-color: #667eea; }
        .chat-name-input::placeholder { color: rgba(255,255,255,0.25); }
        .chat-name-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 0.9rem;
            font-weight: 700;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chat-name-btn:hover { transform: scale(1.02); }

        /* Messages area */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            scroll-behavior: smooth;
        }
        .chat-messages::-webkit-scrollbar { width: 3px; }
        .chat-messages::-webkit-scrollbar-thumb { background: rgba(102,126,234,0.4); border-radius: 3px; }

        .chat-msg {
            display: flex;
            flex-direction: column;
            max-width: 85%;
            animation: msgIn 0.3s ease-out;
        }
        @keyframes msgIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-msg.own { align-self: flex-end; align-items: flex-end; }
        .chat-msg.other { align-self: flex-start; align-items: flex-start; }
        .chat-msg.system { align-self: center; align-items: center; }

        .chat-msg-name {
            font-size: 0.68rem;
            color: rgba(255,255,255,0.4);
            margin-bottom: 3px;
            padding: 0 6px;
        }
        .chat-msg.own .chat-msg-name { color: rgba(102,126,234,0.7); }

        .chat-msg-bubble {
            padding: 8px 12px;
            border-radius: 14px;
            font-size: 0.85rem;
            line-height: 1.4;
            word-break: break-word;
        }
        .chat-msg.own .chat-msg-bubble {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .chat-msg.other .chat-msg-bubble {
            background: rgba(255,255,255,0.1);
            color: white;
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .chat-msg.system .chat-msg-bubble {
            background: rgba(46,213,115,0.1);
            color: rgba(46,213,115,0.8);
            font-size: 0.75rem;
            border: 1px solid rgba(46,213,115,0.2);
            border-radius: 20px;
            padding: 5px 12px;
        }
        .chat-msg-time {
            font-size: 0.62rem;
            color: rgba(255,255,255,0.25);
            margin-top: 2px;
            padding: 0 6px;
        }

        /* Input area */
        .chat-input-area {
            padding: 10px 12px;
            border-top: 1px solid rgba(255,255,255,0.07);
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }
        .chat-input {
            flex: 1;
            background: rgba(255,255,255,0.07);
            border: 1.5px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            color: white;
            font-size: 0.85rem;
            padding: 9px 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        .chat-input:focus { border-color: rgba(102,126,234,0.6); }
        .chat-input::placeholder { color: rgba(255,255,255,0.2); }
        .chat-send-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .chat-send-btn:hover { transform: scale(1.1); }

        .chat-footer-name {
            padding: 6px 14px;
            font-size: 0.68rem;
            color: rgba(255,255,255,0.25);
            text-align: center;
            border-top: 1px solid rgba(255,255,255,0.04);
            flex-shrink: 0;
        }
        .chat-footer-name span {
            color: rgba(102,126,234,0.6);
            cursor: pointer;
        }
        .chat-footer-name span:hover { color: #667eea; text-decoration: underline; }


        /* ===== EMOJI PICKER ===== */
        .emoji-toggle-btn {
            background: rgba(255,255,255,0.08);
            border: 1.5px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        .emoji-toggle-btn:hover { background: rgba(255,255,255,0.15); transform: scale(1.1); }
        .emoji-toggle-btn.active { background: rgba(102,126,234,0.25); border-color: rgba(102,126,234,0.5); }

        .emoji-picker {
            display: none;
            flex-direction: column;
            background: rgba(8, 8, 25, 0.98);
            border: 1.5px solid rgba(102,126,234,0.3);
            border-radius: 16px;
            margin: 0 10px 6px;
            overflow: hidden;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.4);
            max-height: 220px;
        }
        .emoji-picker.active { display: flex; flex-direction: column; }

        .emoji-tabs {
            display: flex;
            gap: 2px;
            padding: 8px 8px 4px;
            border-bottom: 1px solid rgba(255,255,255,0.07);
            overflow-x: auto;
            scrollbar-width: none;
            flex-shrink: 0;
        }
        .emoji-tabs::-webkit-scrollbar { display: none; }

        .emoji-tab {
            background: transparent;
            border: none;
            border-radius: 8px;
            padding: 5px 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .emoji-tab:hover { background: rgba(255,255,255,0.1); }
        .emoji-tab.active { background: rgba(102,126,234,0.35); }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 2px;
            padding: 8px;
            overflow-y: auto;
            flex: 1;
            scrollbar-width: thin;
            scrollbar-color: rgba(102,126,234,0.4) transparent;
        }
        .emoji-grid::-webkit-scrollbar { width: 3px; }
        .emoji-grid::-webkit-scrollbar-thumb { background: rgba(102,126,234,0.4); border-radius: 3px; }

        .emoji-item {
            background: transparent;
            border: none;
            border-radius: 8px;
            padding: 5px;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .emoji-item:hover { background: rgba(255,255,255,0.12); transform: scale(1.2); }
        .emoji-item:active { transform: scale(0.9); }

        @media (max-width: 480px) {
            .chat-window { width: calc(100vw - 30px); right: 15px; bottom: 80px; }
            .chat-toggle-btn { right: 15px; bottom: 15px; }
        }

        #chatToggleBtn {
            position: fixed !important;
            top: 50% !important;
            right: 15px !important;
            bottom: auto !important;
            left: auto !important;
            transform: translateY(-50%) !important;
            z-index: 2147483647 !important;
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: all !important;
            width: 50px !important;
            height: 50px !important;
            background: linear-gradient(135deg, #667eea, #764ba2) !important;
            border-radius: 50% !important;
            border: none !important;
            color: white !important;
            font-size: 1.3rem !important;
            cursor: pointer !important;
            box-shadow: 0 4px 20px rgba(102,126,234,0.6) !important;
            align-items: center !important;
            justify-content: center !important;
        }
        #chatWindow {
            position: fixed !important;
            top: 50% !important;
            right: 75px !important;
            bottom: auto !important;
            left: auto !important;
            transform: translateY(-50%) !important;
            z-index: 2147483646 !important;
        }
        .auth-trigger { top: 10px !important; left: 15px !important; }
        .user-profile { top: 10px !important; left: 15px !important; }


    
        /* ===== PASSWORD STRENGTH ===== */
        .pw-req {
            font-size: 0.72rem;
            color: rgba(255,255,255,0.5);
            padding: 2px 0;
            transition: color 0.3s;
        }
        #signupPassword, #signupPasswordConfirm {
            padding-right: 40px !important;
        }
    
        /* ===== OWNER PANEL EXTRA ===== */
        .owner-tabs {
            display: flex;
            gap: 5px;
            margin: 12px 0 8px;
            flex-wrap: wrap;
        }
        .owner-tab {
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 20px;
            color: rgba(255,255,255,0.6);
            padding: 5px 10px;
            font-size: 0.72rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }
        .owner-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: transparent;
            color: white;
        }
        .owner-tab-content { display: none; }
        .owner-tab-content.active { display: block; }
        .owner-section-title {
            font-size: 0.8rem;
            font-weight: 700;
            color: rgba(255,255,255,0.8);
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        .owner-textarea {
            width: 100%;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 10px;
            color: white;
            padding: 8px 12px;
            font-size: 0.8rem;
            resize: vertical;
            min-height: 70px;
            font-family: inherit;
            box-sizing: border-box;
        }
        .owner-textarea:focus { outline: none; border-color: #667eea; }
        .owner-action-btn {
            border: none;
            border-radius: 20px;
            padding: 7px 14px;
            font-size: 0.78rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .owner-action-btn.green { background: linear-gradient(135deg,#2ed573,#1abc9c); color: #000; }
        .owner-action-btn.red { background: linear-gradient(135deg,#ff4757,#c44569); color: white; }
        .owner-action-btn.blue { background: linear-gradient(135deg,#667eea,#764ba2); color: white; }
        .owner-action-btn:hover { transform: scale(1.04); }
        .user-ban-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 6px 10px;
            margin-bottom: 5px;
            font-size: 0.78rem;
        }
        .user-ban-item .user-name-lbl { color: rgba(255,255,255,0.8); }
        .user-ban-item .ban-btn {
            background: #ff4757;
            border: none;
            border-radius: 10px;
            color: white;
            padding: 3px 8px;
            font-size: 0.68rem;
            cursor: pointer;
            font-weight: 700;
        }
        .user-ban-item .unban-btn {
            background: #2ed573;
            border: none;
            border-radius: 10px;
            color: #000;
            padding: 3px 8px;
            font-size: 0.68rem;
            cursor: pointer;
            font-weight: 700;
        }
        .visitor-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 6px 10px;
            margin-bottom: 5px;
            font-size: 0.78rem;
            color: rgba(255,255,255,0.8);
        }

        /* Announcement Banner */
        .announce-banner {
            position: fixed;
            top: 0; left: 0; right: 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            text-align: center;
            padding: 10px 40px;
            font-size: 0.88rem;
            font-weight: 700;
            z-index: 999999;
            box-shadow: 0 4px 20px rgba(102,126,234,0.5);
            display: none;
            animation: slideDown 0.4s ease-out;
        }
        .announce-banner.show { display: block; }
        .announce-banner-close {
            position: absolute;
            right: 15px; top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            opacity: 0.8;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
    </style>

    <style>
    /* Security layer */
    </style>
    <script>
    // Disable right click
    document.addEventListener('contextmenu', function(e){ e.preventDefault(); });
    // Disable F12, Ctrl+Shift+I, Ctrl+U
    document.addEventListener('keydown', function(e){
        if(e.key==='F12'||(e.ctrlKey&&e.shiftKey&&(e.key==='I'||e.key==='J'||e.key==='C'))||(e.ctrlKey&&e.key==='u')||(e.ctrlKey&&e.key==='s')){
            e.preventDefault(); return false;
        }
    });
    </script>
</head>
<body>
    <!-- Announcement Banner -->
    <div class="announce-banner" id="announceBanner">
        <span id="announceBannerText"></span>
        <button class="announce-banner-close" onclick="dismissAnnouncement()">✕</button>
    </div>

    <!-- Animated Starry Night Background -->
    <div class="wallpaper-container">
        <div class="stars"></div>
        <div class="moon"></div>
        <div class="shooting-star"></div>
        <div class="shooting-star"></div>
        <div class="shooting-star"></div>
    </div>
    
    <!-- Overlay -->
    <div class="overlay"></div>

    <!-- Loading Indicator -->
    <div class="loading" id="loading">Loading...</div>

    <!-- Search Bar -->
    <div class="search-section" id="searchSection">
        <div class="search-wrapper">
            <input type="text" class="search-input" id="searchInput" placeholder="🔍  Search any song...">
            <button class="search-btn" id="searchBtn">🔍</button>
        </div>
        <div class="suggestions-box" id="suggestionsBox"></div>
        <div class="search-results" id="searchResults"></div>

        <!-- Search Results Panel -->
        <div id="searchPanel" style="
            display:none;
            position:absolute;
            top:calc(100% + 10px);
            left:0; right:0;
            z-index:500;
            background:rgba(6,2,18,0.97);
            backdrop-filter:blur(24px);
            -webkit-backdrop-filter:blur(24px);
            border:1.5px solid rgba(102,126,234,0.35);
            border-radius:20px;
            overflow:hidden;
            box-shadow:0 20px 60px rgba(0,0,0,0.9);
            max-height:420px;
        ">
            <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid rgba(255,255,255,0.07);">
                <span id="panelLabel" style="color:rgba(255,255,255,0.7);font-size:0.82rem;font-weight:600;letter-spacing:0.3px;">🎵 Results</span>
                <button onclick="closePanel()" style="background:none;border:none;color:rgba(255,255,255,0.35);font-size:1.15rem;cursor:pointer;padding:2px 8px;line-height:1;transition:color 0.2s;" onmouseover="this.style.color='white'" onmouseout="this.style.color='rgba(255,255,255,0.35)'">✕</button>
            </div>
            <div id="panelBody" style="overflow-y:auto;max-height:370px;"></div>
        </div>
    </div>

    <!-- YouTube Player (hidden) -->
    <div id="yt-player"></div>

    <!-- Upload Section -->
    <div class="upload-section">
        <label for="music-upload" class="upload-btn">
            🎵 Upload Song
        </label>
        <input type="file" id="music-upload" accept="audio/*">
        
        <label for="dj-avatar-upload" class="upload-btn">
            🎧 Upload DJ Avatar
        </label>
        <input type="file" id="dj-avatar-upload" accept="image/*">
    </div>

    <!-- Main Content -->
    <div class="content">
        <h1>My Immersive Space</h1>
        <p class="subtitle">🌙🎵 Feel the beat, own the night 🎵🌙</p>
    </div>

    <!-- Music Control Panel -->
    <div class="music-control">
        <button class="play-pause-btn" id="playPauseBtn">
            <svg id="playIcon" viewBox="0 0 24 24">
                <path d="M8 5v14l11-7z"/>
            </svg>
            <svg id="pauseIcon" style="display: none;" viewBox="0 0 24 24">
                <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
            </svg>
        </button>
        
        <div class="song-info">
            <div class="song-title" id="songTitle">No song loaded</div>
            <div class="song-status" id="songStatus">Upload a song to begin</div>
        </div>
    </div>

    <!-- DJ Avatar Visualizer -->
    <div class="dj-avatar" id="djAvatar">
        <div class="audio-wave"></div>
        <div class="audio-wave"></div>
        <div class="audio-wave"></div>
        <img id="djAvatarImg" src="" alt="DJ Avatar">
    </div>

    <!-- Login/Signup Trigger Button -->
    <button class="auth-trigger" id="authTrigger">Login / Sign Up</button>

    <!-- User Profile -->
    <div class="user-profile" id="userProfile">
        <div class="user-avatar" id="userAvatar" id="userAvatarBtn" style="cursor:pointer;" title="My Profile">S</div>
        <div class="user-name" id="userName">User</div>
        <button class="my-profile-btn" id="myProfileBtn">👤 My Profile</button>
        <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>

    <!-- My Profile Modal -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-box">
            <button class="profile-close" id="closeProfileBtn">&times;</button>

            <div class="profile-header">
                <div class="profile-avatar-wrap">
                    <div class="profile-avatar-display" id="profileAvatarDisplay">S</div>
                    <div class="profile-avatar-badge">✏️</div>
                </div>
                <div class="profile-username" id="profileUsername">User</div>
                <div class="profile-email" id="profileEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="3c494f594e7c59515d5550125f5351">[email&#160;protected]</a></div>
            </div>

            <!-- Logo Picker -->
            <div class="profile-section-title">🎨 Choose Avatar</div>
            <div class="logo-presets" id="logoPresets">
                <div class="logo-preset" data-logo="🎵">🎵</div>
                <div class="logo-preset" data-logo="🎧">🎧</div>
                <div class="logo-preset" data-logo="🎤">🎤</div>
                <div class="logo-preset" data-logo="🎸">🎸</div>
                <div class="logo-preset" data-logo="🎹">🎹</div>
                <div class="logo-preset" data-logo="🥁">🥁</div>
                <div class="logo-preset" data-logo="🎺">🎺</div>
                <div class="logo-preset" data-logo="🎻">🎻</div>
                <div class="logo-preset" data-logo="🦁">🦁</div>
                <div class="logo-preset" data-logo="🐯">🐯</div>
                <div class="logo-preset" data-logo="🦊">🦊</div>
                <div class="logo-preset" data-logo="🐺">🐺</div>
                <div class="logo-preset" data-logo="🌟">🌟</div>
                <div class="logo-preset" data-logo="🔥">🔥</div>
                <div class="logo-preset" data-logo="💎">💎</div>
                <div class="logo-preset" data-logo="👑">👑</div>
            </div>

            <!-- Upload custom image -->
            <div class="profile-section-title">📁 Upload Image</div>
            <div class="profile-upload-area" id="profileUploadArea">
                <input type="file" id="profileImgInput" accept="image/*" style="display:none">
                <div class="upload-icon">⬆️</div>
                <div class="upload-text">Click to upload photo</div>
                <div class="upload-sub">JPG, PNG, GIF (max 2MB)</div>
            </div>

            <!-- Name edit -->
            <div class="profile-section-title">✏️ Display Name</div>
            <div class="profile-name-row">
                <input type="text" class="profile-name-input" id="profileNameInput" placeholder="Enter display name...">
                <button class="profile-save-btn" id="profileSaveBtn">💾 Save</button>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-container">
            <button class="close-auth" id="closeAuthBtn">&times;</button>
            
            <div class="auth-tabs">
                <button class="auth-tab active" id="loginTab">Login</button>
                <button class="auth-tab" id="signupTab">Sign Up</button>
            </div>

            <!-- Login Form -->
            <form class="auth-form active" id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="auth-submit">Login</button>
            </form>

            <!-- Signup Form -->
            <form class="auth-form" id="signupForm">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="signupName" placeholder="Enter your name" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signupEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <div style="position:relative;">
                        <input type="password" id="signupPassword" placeholder="Min 8 chars, A-Z, 0-9, @#$..." required oninput="checkPasswordStrength(this.value)" autocomplete="new-password">
                        <span id="pwToggle" onclick="togglePwVisibility()" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:1rem;opacity:0.6;">👁️</span>
                    </div>
                    <!-- Strength Bar -->
                    <div id="pwStrengthBar" style="height:4px;border-radius:4px;margin-top:6px;background:#333;overflow:hidden;display:none;">
                        <div id="pwStrengthFill" style="height:100%;width:0%;transition:all 0.3s;border-radius:4px;"></div>
                    </div>
                    <div id="pwStrengthText" style="font-size:0.72rem;margin-top:4px;display:none;"></div>
                    <!-- Requirements -->
                    <div id="pwReqs" style="margin-top:8px;display:none;">
                        <div class="pw-req" id="req-len">&#x25CB; Min 8 characters</div>
                        <div class="pw-req" id="req-upper">&#x25CB; Uppercase letter (A-Z)</div>
                        <div class="pw-req" id="req-lower">&#x25CB; Lowercase letter (a-z)</div>
                        <div class="pw-req" id="req-num">&#x25CB; Number (0-9)</div>
                        <div class="pw-req" id="req-special">&#x25CB; Special char (!@#$%^&*)</div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <div style="position:relative;">
                        <input type="password" id="signupPasswordConfirm" placeholder="Re-enter password" required oninput="checkPasswordMatch()" autocomplete="new-password">
                    </div>
                    <div id="pwMatchText" style="font-size:0.72rem;margin-top:4px;display:none;"></div>
                </div>
                <button type="submit" class="auth-submit" id="signupSubmitBtn">Sign Up</button>
            </form>
        </div>
    </div>

    <!-- Credit Footer -->
    <div class="credit">
        Created by :- <strong>Sanithu</strong>
        <br>
        <a href="https://wa.me/94742323368" target="_blank" class="whatsapp-link">
            📱 WhatsApp: +94 74 232 3368
        </a>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // Get elements
        const musicUpload = document.getElementById('music-upload');
        const djAvatarUpload = document.getElementById('dj-avatar-upload');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const songTitle = document.getElementById('songTitle');
        const songStatus = document.getElementById('songStatus');
        const loading = document.getElementById('loading');
        const djAvatar = document.getElementById('djAvatar');
        const djAvatarImg = document.getElementById('djAvatarImg');

        // Web Audio API variables
        let audioContext;
        let audioBuffer;
        let sourceNode;
        let isPlaying = false;
        let startTime = 0;
        let pauseTime = 0;
        let currentFileName = '';

        // Set DJ avatar image (user should replace this with their uploaded image)
        // For now, using a data URL - user can replace with their own image
        djAvatarImg.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="300"><circle cx="150" cy="150" r="140" fill="%23667eea"/><circle cx="120" cy="120" r="15" fill="white"/><circle cx="180" cy="120" r="15" fill="white"/><path d="M 100 180 Q 150 220 200 180" stroke="white" stroke-width="5" fill="none"/></svg>';

        // Initialize Audio Context
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('🎵 Audio Context initialized');
                console.log('Sample rate:', audioContext.sampleRate);
            }
        }

        // DJ Avatar Upload Handler
        djAvatarUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    djAvatarImg.src = event.target.result;
                    console.log('🎧 DJ Avatar image updated!');
                };
                
                reader.readAsDataURL(file);
            }
        });

        // Music Upload Handler - Using Web Audio API
        musicUpload.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validate audio file
            if (!file.type.startsWith('audio/')) {
                alert('කරුණාකර audio file එකක් තෝරන්න! (MP3, WAV, OGG)');
                return;
            }
            
            loading.classList.add('active');
            songStatus.textContent = 'Loading...';
            
            // Stop any currently playing audio
            if (sourceNode) {
                try {
                    sourceNode.stop();
                } catch (e) {
                    console.log('Source already stopped');
                }
                sourceNode = null;
            }
            isPlaying = false;
            playIcon.style.display = 'block';
            pauseIcon.style.display = 'none';
            
            try {
                // Initialize audio context
                initAudioContext();
                
                console.log('📁 Loading file:', file.name);
                console.log('📊 Size:', (file.size / 1024 / 1024).toFixed(2), 'MB');
                console.log('🎵 Type:', file.type);
                
                // Read file as ArrayBuffer
                const arrayBuffer = await file.arrayBuffer();
                console.log('✅ File read as ArrayBuffer');
                
                songStatus.textContent = 'Decoding audio...';
                
                // Decode audio data
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                console.log('🎶 Audio decoded successfully!');
                console.log('Duration:', audioBuffer.duration.toFixed(2), 'seconds');
                console.log('Channels:', audioBuffer.numberOfChannels);
                console.log('Sample rate:', audioBuffer.sampleRate);
                
                // Update UI
                currentFileName = file.name.replace(/\.[^/.]+$/, "");
                songTitle.textContent = currentFileName;
                songStatus.textContent = 'Ready to play ✓';
                loading.classList.remove('active');
                
                // Reset timing
                startTime = 0;
                pauseTime = 0;
                
            } catch (error) {
                console.error('❌ Error loading audio:', error);
                
                let errorMsg = 'Audio decode කරන්න බැහැ!';
                if (error.name === 'EncodingError') {
                    errorMsg = 'Audio format එක decode කරන්න බැහැ. MP3 හෝ WAV file එකක් try කරන්න!';
                } else if (error.name === 'NotSupportedError') {
                    errorMsg = 'Audio format එක support නෑ. වෙනත් file එකක් try කරන්න!';
                }
                
                alert('⚠️ ' + errorMsg + '\n\n' + error.message);
                songStatus.textContent = 'Error loading';
                loading.classList.remove('active');
                audioBuffer = null;
            }
        });

        // Play Audio Function
        function playAudio() {
            console.log('▶️▶️▶️ playAudio() function called');
            
            if (!audioBuffer) {
                console.log('❌ No audio buffer in playAudio');
                alert('කරුණාකර පළමුව ගීතයක් upload කරන්න! 🎵');
                return;
            }
            
            try {
                console.log('🔊 Audio context state:', audioContext.state);
                
                // Resume audio context if suspended
                if (audioContext.state === 'suspended') {
                    console.log('⚠️ Audio context suspended, resuming...');
                    audioContext.resume().then(() => {
                        console.log('✅ Audio context resumed');
                    });
                }
                
                console.log('🎵 Creating source node...');
                // Create new source node
                sourceNode = audioContext.createBufferSource();
                sourceNode.buffer = audioBuffer;
                sourceNode.loop = true; // Loop the audio
                sourceNode.connect(audioContext.destination);
                
                console.log('✅ Source node created and connected');
                
                // Calculate offset if resuming from pause
                const offset = pauseTime % audioBuffer.duration;
                console.log('⏩ Starting from offset:', offset.toFixed(2), 'seconds');
                
                // Start playing
                sourceNode.start(0, offset);
                startTime = audioContext.currentTime - offset;
                
                console.log('🎶 Audio started playing!');
                console.log('Start time:', startTime);
                console.log('Current time:', audioContext.currentTime);
                
                // Update UI
                isPlaying = true;
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
                songStatus.textContent = 'Now playing...';
                
                // Show and animate DJ avatar
                djAvatar.classList.add('active');
                djAvatar.classList.add('playing');
                
                console.log('✅ UI updated - play icon hidden, pause icon shown');
                console.log('🎧 DJ Avatar activated!');
                
                // Handle when audio ends (though it loops)
                sourceNode.onended = function() {
                    console.log('🔚 Source node ended');
                    if (isPlaying) {
                        console.log('🔄 Audio loop ended, restarting...');
                    }
                };
                
            } catch (error) {
                console.error('❌❌❌ Play error:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                alert('Play කරන්න දෝෂයක්!\n\n' + error.message);
                isPlaying = false;
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
            }
        }

        // Pause Audio Function
        function pauseAudio() {
            if (sourceNode && isPlaying) {
                try {
                    // Calculate current position
                    pauseTime = (audioContext.currentTime - startTime) % audioBuffer.duration;
                    
                    // Stop the source
                    sourceNode.stop();
                    sourceNode = null;
                    
                    // Update UI
                    isPlaying = false;
                    playIcon.style.display = 'block';
                    pauseIcon.style.display = 'none';
                    songStatus.textContent = 'Paused';
                    
                    // Stop DJ avatar animation
                    djAvatar.classList.remove('playing');
                    
                    console.log('⏸️ Paused at:', pauseTime.toFixed(2), 'seconds');
                    
                } catch (error) {
                    console.error('❌ Pause error:', error);
                }
            }
        }

        // Play/Pause Button Handler
        playPauseBtn.addEventListener('click', function(event) {
            event.stopPropagation();

            // ---- YouTube song replay after ended ----
            if (window.lastSongEnded && window.lastYtVideoId) {
                window.lastSongEnded = false;
                playYouTubeVideo(window.lastYtVideoId, lastStreamTitle, lastStreamArtist);
                return;
            }

            // ---- Stream song replay after ended ----
            if (window.lastSongEnded && lastStreamUrl) {
                window.lastSongEnded = false;
                playStreamSong(lastStreamUrl, lastStreamTitle, lastStreamArtist);
                return;
            }

            // ---- Handle YouTube player pause/resume ----
            if (ytReady && ytPlayer && window.lastYtVideoId) {
                const state = ytPlayer.getPlayerState();
                if (state === YT.PlayerState.PLAYING) {
                    ytPlayer.pauseVideo();
                    playIcon.style.display = 'block';
                    pauseIcon.style.display = 'none';
                    djAvatar.classList.remove('playing');
                    songStatus.textContent = '⏸ Paused';
                    window.ytPlaying = false;
                } else if (state === YT.PlayerState.PAUSED) {
                    ytPlayer.playVideo();
                    playIcon.style.display = 'none';
                    pauseIcon.style.display = 'block';
                    djAvatar.classList.add('playing');
                    songStatus.textContent = `🎤 ${lastStreamArtist} ♪ Playing...`;
                    window.ytPlaying = true;
                }
                return;
            }

            // ---- Handle Stream Audio (Search songs) ----
            if (window.previewAudio && window.previewAudio.src) {
                if (window.previewAudio.paused) {
                    window.previewAudio.play();
                    playIcon.style.display = 'none';
                    pauseIcon.style.display = 'block';
                    djAvatar.classList.add('playing');
                } else {
                    window.previewAudio.pause();
                    playIcon.style.display = 'block';
                    pauseIcon.style.display = 'none';
                    djAvatar.classList.remove('playing');
                    songStatus.textContent = '⏸ Paused';
                }
                return;
            }

            // ---- Handle Local Upload Audio ----
            if (!audioBuffer) {
                alert('කරුණාකර පළමුව ගීතයක් upload කරන්න! 🎵');
                return;
            }
            if (isPlaying) {
                pauseAudio();
            } else {
                playAudio();
            }
        });

        // Log browser info
        console.log('🌐 Browser:', navigator.userAgent);
        console.log('🎵 Web Audio API support:', !!(window.AudioContext || window.webkitAudioContext));
        
        // Test button on page load
        setTimeout(() => {
            console.log('🧪 Testing button...');
            console.log('Button element:', playPauseBtn);
            console.log('Button visible:', playPauseBtn.offsetParent !== null);
            console.log('Button dimensions:', playPauseBtn.offsetWidth, 'x', playPauseBtn.offsetHeight);
            console.log('Button position:', playPauseBtn.getBoundingClientRect());
        }, 2000);

        // ========== AUTHENTICATION SYSTEM ==========
        
        const authModal = document.getElementById('authModal');
        const authTrigger = document.getElementById('authTrigger');
        const closeAuthBtn = document.getElementById('closeAuthBtn');
        const loginTab = document.getElementById('loginTab');
        const signupTab = document.getElementById('signupTab');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const userProfile = document.getElementById('userProfile');
        const logoutBtn = document.getElementById('logoutBtn');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');

        // Open auth modal
        authTrigger.addEventListener('click', function() {
            authModal.classList.add('active');
        });

        // Close auth modal
        closeAuthBtn.addEventListener('click', function() {
            authModal.classList.remove('active');
        });

        // Close on background click
        authModal.addEventListener('click', function(e) {
            if (e.target === authModal) {
                authModal.classList.remove('active');
            }
        });

        // Switch to login tab
        loginTab.addEventListener('click', function() {
            loginTab.classList.add('active');
            signupTab.classList.remove('active');
            loginForm.classList.add('active');
            signupForm.classList.remove('active');
        });

        // Switch to signup tab
        signupTab.addEventListener('click', function() {
            signupTab.classList.add('active');
            loginTab.classList.remove('active');
            signupForm.classList.add('active');
            loginForm.classList.remove('active');
        });

        // Handle login
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.email === email && u.password === password);
            
            if (user) {
                localStorage.setItem('currentUser', JSON.stringify(user));
                showUserProfile(user);
                authModal.classList.remove('active');
                alert('✅ Login successful! Welcome back, ' + user.name + '! 🎵');
                loginForm.reset();
            } else {
                alert('❌ Invalid email or password!');
            }
        });

        // Handle signup
        signupForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirm = document.getElementById('signupPasswordConfirm').value;

            // Validate password strength
            var result = validatePassword(password);
            if (!result.valid) {
                showAuthError(result.message);
                document.getElementById('signupPassword').style.borderColor = '#ff4757';
                setTimeout(function(){ document.getElementById('signupPassword').style.borderColor = ''; }, 2000);
                return;
            }

            // Check passwords match
            if (password !== confirm) {
                showAuthError('Passwords do not match!');
                document.getElementById('signupPasswordConfirm').style.borderColor = '#ff4757';
                setTimeout(function(){ document.getElementById('signupPasswordConfirm').style.borderColor = ''; }, 2000);
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '[]');
            if (users.find(function(u){ return u.email === email; })) {
                showAuthError('Email already registered!');
                return;
            }

            const newUser = { name: name, email: email, password: password };
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(newUser));

            showUserProfile(newUser);
            authModal.classList.remove('active');
            showSuccessFlash('Account created! Welcome, ' + name + '! ');
            signupForm.reset();
            resetPasswordUI();
        });

        function validatePassword(pw) {
            if (pw.length < 8) return { valid: false, message: 'Password must be at least 8 characters!' };
            if (!/[A-Z]/.test(pw)) return { valid: false, message: 'Add at least one uppercase letter (A-Z)!' };
            if (!/[a-z]/.test(pw)) return { valid: false, message: 'Add at least one lowercase letter (a-z)!' };
            if (!/[0-9]/.test(pw)) return { valid: false, message: 'Add at least one number (0-9)!' };
            if (!/[!@#$%^&*()_+\-=\[\]{};':"\|,.<>\/?]/.test(pw)) return { valid: false, message: 'Add at least one special character (!@#$%...)!' };
            return { valid: true };
        }

        window.checkPasswordStrength = function(pw) {
            var bar = document.getElementById('pwStrengthBar');
            var fill = document.getElementById('pwStrengthFill');
            var text = document.getElementById('pwStrengthText');
            var reqs = document.getElementById('pwReqs');
            if (!bar) return;

            if (pw.length === 0) { bar.style.display='none'; text.style.display='none'; reqs.style.display='none'; return; }
            bar.style.display='block'; text.style.display='block'; reqs.style.display='block';

            // Check requirements
            var hasLen = pw.length >= 8;
            var hasUpper = /[A-Z]/.test(pw);
            var hasLower = /[a-z]/.test(pw);
            var hasNum = /[0-9]/.test(pw);
            var hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\|,.<>\/?]/.test(pw);

            function setReq(id, ok) {
                var el = document.getElementById(id);
                if (!el) return;
                el.innerHTML = (ok ? '&#x2705;' : '&#x25CB;') + ' ' + el.innerHTML.replace(/^[^\s]+\s/, '');
                el.style.color = ok ? '#2ed573' : 'rgba(255,255,255,0.5)';
            }
            setReq('req-len', hasLen);
            setReq('req-upper', hasUpper);
            setReq('req-lower', hasLower);
            setReq('req-num', hasNum);
            setReq('req-special', hasSpecial);

            var score = [hasLen, hasUpper, hasLower, hasNum, hasSpecial].filter(Boolean).length;
            var colors = ['#ff4757','#ff6348','#ffa502','#2ed573','#1abc9c'];
            var labels = ['Very Weak','Weak','Fair','Strong','Very Strong'];
            fill.style.width = (score * 20) + '%';
            fill.style.background = colors[score-1] || '#ff4757';
            text.textContent = 'Strength: ' + (labels[score-1] || 'Very Weak');
            text.style.color = colors[score-1] || '#ff4757';
        };

        window.checkPasswordMatch = function() {
            var pw = document.getElementById('signupPassword').value;
            var confirm = document.getElementById('signupPasswordConfirm').value;
            var matchEl = document.getElementById('pwMatchText');
            if (!matchEl || confirm.length === 0) return;
            matchEl.style.display = 'block';
            if (pw === confirm) {
                matchEl.textContent = 'Passwords match!';
                matchEl.style.color = '#2ed573';
                document.getElementById('signupPasswordConfirm').style.borderColor = '#2ed573';
            } else {
                matchEl.textContent = 'Passwords do not match!';
                matchEl.style.color = '#ff4757';
                document.getElementById('signupPasswordConfirm').style.borderColor = '#ff4757';
            }
        };

        window.togglePwVisibility = function() {
            var inp = document.getElementById('signupPassword');
            var inp2 = document.getElementById('signupPasswordConfirm');
            var toggle = document.getElementById('pwToggle');
            if (inp.type === 'password') {
                inp.type = 'text'; inp2.type = 'text'; toggle.textContent = '🙈';
            } else {
                inp.type = 'password'; inp2.type = 'password'; toggle.textContent = '👁️';
            }
        };

        function resetPasswordUI() {
            var ids = ['pwStrengthBar','pwStrengthText','pwReqs','pwMatchText'];
            ids.forEach(function(id){ var el=document.getElementById(id); if(el) el.style.display='none'; });
        }

        function showAuthError(msg) {
            var existing = document.getElementById('authErrorMsg');
            if (existing) existing.remove();
            var div = document.createElement('div');
            div.id = 'authErrorMsg';
            div.style.cssText = 'background:rgba(255,71,87,0.15);border:1px solid #ff4757;border-radius:10px;padding:10px 15px;color:#ff4757;font-size:0.82rem;margin-bottom:10px;text-align:center;';
            div.textContent = '❌ ' + msg;
            var submitBtn = document.getElementById('signupSubmitBtn');
            if (submitBtn) submitBtn.parentNode.insertBefore(div, submitBtn);
            setTimeout(function(){ if(div.parentNode) div.remove(); }, 4000);
        }

        function showSuccessFlash(msg) {
            var f = document.createElement('div');
            f.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#2ed573,#1abc9c);color:#000;padding:12px 28px;border-radius:30px;font-weight:700;z-index:9999999;font-size:0.95rem;box-shadow:0 8px 25px rgba(0,0,0,0.4);';
            f.textContent = '🎉 ' + msg;
            document.body.appendChild(f);
            setTimeout(function(){ f.remove(); }, 3000);
        }

        // Show user profile
        // ===== PROFILE SYSTEM =====
        const profileModal      = document.getElementById('profileModal');
        const myProfileBtn      = document.getElementById('myProfileBtn');
        const closeProfileBtn   = document.getElementById('closeProfileBtn');
        const profileSaveBtn    = document.getElementById('profileSaveBtn');
        const profileNameInput  = document.getElementById('profileNameInput');
        const profileAvatarDisplay = document.getElementById('profileAvatarDisplay');
        const profileUsername   = document.getElementById('profileUsername');
        const profileEmail      = document.getElementById('profileEmail');
        const logoPresets       = document.getElementById('logoPresets');
        const profileUploadArea = document.getElementById('profileUploadArea');
        const profileImgInput   = document.getElementById('profileImgInput');

        let currentLogoData = null; // stores emoji or image dataURL

        function showUserProfile(user) {
            authTrigger.classList.add('hidden');
            userProfile.classList.add('active');
            userName.textContent = user.name;

            // Load saved avatar
            const savedLogo = localStorage.getItem('profileLogo_' + user.email);
            if (savedLogo) {
                applyAvatar(savedLogo);
            } else {
                userAvatar.textContent = user.name.charAt(0).toUpperCase();
                userAvatar.style.backgroundImage = '';
            }
        }

        function applyAvatar(logoData) {
            currentLogoData = logoData;
            // If it's an emoji (short string)
            if (logoData.length <= 4) {
                userAvatar.textContent = logoData;
                userAvatar.style.backgroundImage = '';
                profileAvatarDisplay.textContent = logoData;
                profileAvatarDisplay.innerHTML = logoData;
            } else {
                // It's a base64 image
                userAvatar.innerHTML = '<img src="' + logoData + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
                profileAvatarDisplay.innerHTML = '<img src="' + logoData + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
            }
        }

        // Open profile modal
        myProfileBtn.addEventListener('click', function() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user) return;
            profileUsername.textContent  = user.name;
            profileEmail.textContent     = user.email || '';
            profileNameInput.value       = user.name;

            // Show current avatar in modal
            const savedLogo = localStorage.getItem('profileLogo_' + user.email);
            if (savedLogo && savedLogo.length <= 4) {
                profileAvatarDisplay.innerHTML = savedLogo;
            } else if (savedLogo) {
                profileAvatarDisplay.innerHTML = '<img src="' + savedLogo + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
            } else {
                profileAvatarDisplay.textContent = user.name.charAt(0).toUpperCase();
            }

            profileModal.classList.add('active');
        });

        // Close profile modal
        closeProfileBtn.addEventListener('click', function() {
            profileModal.classList.remove('active');
        });
        profileModal.addEventListener('click', function(e) {
            if (e.target === profileModal) profileModal.classList.remove('active');
        });

        // Logo preset click
        logoPresets.querySelectorAll('.logo-preset').forEach(function(preset) {
            preset.addEventListener('click', function() {
                logoPresets.querySelectorAll('.logo-preset').forEach(function(p) { p.classList.remove('selected'); });
                preset.classList.add('selected');
                applyAvatar(preset.dataset.logo);
            });
        });

        // Upload area click
        profileUploadArea.addEventListener('click', function() {
            profileImgInput.click();
        });

        profileImgInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) {
                alert('❌ Image too large! Max 2MB.');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(ev) {
                applyAvatar(ev.target.result);
                logoPresets.querySelectorAll('.logo-preset').forEach(function(p) { p.classList.remove('selected'); });
            };
            reader.readAsDataURL(file);
        });

        // Save profile
        profileSaveBtn.addEventListener('click', function() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user) return;

            // Update name
            const newName = profileNameInput.value.trim();
            if (newName) {
                user.name = newName;
                localStorage.setItem('currentUser', JSON.stringify(user));
                // Update in users array too
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const idx = users.findIndex(function(u) { return u.email === user.email; });
                if (idx !== -1) { users[idx].name = newName; localStorage.setItem('users', JSON.stringify(users)); }
                userName.textContent = newName;
                profileUsername.textContent = newName;
            }

            // Save avatar
            if (currentLogoData) {
                localStorage.setItem('profileLogo_' + user.email, currentLogoData);
                applyAvatar(currentLogoData);
            }

            profileModal.classList.remove('active');

            // Show success flash
            const flash = document.createElement('div');
            flash.textContent = '✅ Profile saved!';
            flash.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:12px 28px;border-radius:30px;font-weight:700;z-index:9999;font-size:0.95rem;box-shadow:0 8px 25px rgba(0,0,0,0.4);';
            document.body.appendChild(flash);
            setTimeout(function() { flash.remove(); }, 2200);
        });

        // Logout
        logoutBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('currentUser');
                userProfile.classList.remove('active');
                authTrigger.classList.remove('hidden');
                currentLogoData = null;
            }
        });

        // Check if user is already logged in
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (currentUser) {
            showUserProfile(currentUser);
        }

        // ========== YOUTUBE SEARCH SYSTEM ==========

        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const searchResults = document.getElementById('searchResults');
        const suggestionsBox = document.getElementById('suggestionsBox');

        let ytPlayer = null;
        let ytReady = false;
        let suggestTimeout = null;
        let selectedIndex = -1;
        let currentSuggestions = [];

        // Load YouTube IFrame API
        const ytScript = document.createElement('script');
        ytScript.src = 'https://www.youtube.com/iframe_api';
        document.head.appendChild(ytScript);

        window.onYouTubeIframeAPIReady = function() {
            ytReady = true;
            ytPlayer = new YT.Player('yt-player', {
                height: '0',
                width: '0',
                playerVars: { autoplay: 1 },
                events: {
                    onStateChange: function(e) {
                        if (e.data === YT.PlayerState.PLAYING) {
                            djAvatar.classList.add('active');
                            djAvatar.classList.add('playing');
                            playIcon.style.display = 'none';
                            pauseIcon.style.display = 'block';
                            window.ytPlaying = true;
                            window.lastSongEnded = false;
                        } else if (e.data === YT.PlayerState.PAUSED) {
                            djAvatar.classList.remove('playing');
                            playIcon.style.display = 'block';
                            pauseIcon.style.display = 'none';
                            window.ytPlaying = false;
                        } else if (e.data === YT.PlayerState.ENDED) {
                            djAvatar.classList.remove('playing');
                            songStatus.textContent = '🔁 Tap ▶ to replay';
                            playIcon.style.display = 'block';
                            pauseIcon.style.display = 'none';
                            window.ytPlaying = false;
                            window.lastSongEnded = true;
                        } else if (e.data === YT.PlayerState.BUFFERING) {
                            songStatus.textContent = '⏳ Buffering...';
                        }
                    },
                    onError: function(e) {
                        songStatus.textContent = '❌ Video unavailable. Try another song.';
                        djAvatar.classList.remove('playing');
                        playIcon.style.display = 'block';
                        pauseIcon.style.display = 'none';
                        window.ytPlaying = false;
                    }
                }
            });
        };

        // ---- AUTOCOMPLETE SUGGESTIONS ----
        async function fetchSuggestions(query) {
            if (!query || query.length < 2) {
                hideSuggestions();
                return;
            }
            try {
                // Use Wikipedia/Google suggest proxy for song suggestions
                const res = await fetch(`https://suggestqueries.google.com/complete/search?client=firefox&ds=yt&q=${encodeURIComponent(query)}`, {mode: 'cors'});
                const data = await res.json();
                currentSuggestions = data[1] ? data[1].slice(0, 7) : [];
                showSuggestions(currentSuggestions, query);
            } catch(e) {
                // Fallback: show manual suggestions based on input
                const fallback = [
                    query + ' official audio',
                    query + ' music video',
                    query + ' lyrics',
                    query + ' live',
                    query + ' remix',
                ].slice(0, 5);
                currentSuggestions = fallback;
                showSuggestions(fallback, query);
            }
        }

        function showSuggestions(suggestions, query) {
            if (!suggestions.length) { hideSuggestions(); return; }
            selectedIndex = -1;
            suggestionsBox.innerHTML = '';

            suggestions.forEach((text, i) => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';

                // Bold matching part
                const lower = text.toLowerCase();
                const qLower = query.toLowerCase();
                const idx = lower.indexOf(qLower);
                let display = text;
                if (idx !== -1) {
                    display = text.substring(0, idx) +
                        `<strong>${text.substring(idx, idx + query.length)}</strong>` +
                        text.substring(idx + query.length);
                }

                item.innerHTML = `
                    <span class="suggestion-icon">🎵</span>
                    <span class="suggestion-text">${display}</span>
                    <span class="suggestion-arrow">↵</span>
                `;

                item.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    searchInput.value = text;
                    hideSuggestions();
                    searchSongs(text);
                });

                suggestionsBox.appendChild(item);
            });

            suggestionsBox.classList.add('active');
        }

        function hideSuggestions() {
            suggestionsBox.classList.remove('active');
            selectedIndex = -1;
        }

        // Keyboard navigation for suggestions
        searchInput.addEventListener('keydown', (e) => {
            const items = suggestionsBox.querySelectorAll('.suggestion-item');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                items.forEach((el, i) => el.classList.toggle('selected', i === selectedIndex));
                if (items[selectedIndex]) searchInput.value = items[selectedIndex].querySelector('.suggestion-text').textContent;
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                items.forEach((el, i) => el.classList.toggle('selected', i === selectedIndex));
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const q = searchInput.value.trim();
                hideSuggestions();
                if (q) searchSongs(q);
            } else if (e.key === 'Escape') {
                hideSuggestions();
            }
        });

        // Trigger suggestions on typing
        searchInput.addEventListener('input', () => {
            clearTimeout(suggestTimeout);
            const q = searchInput.value.trim();
            if (q.length >= 2) {
                suggestTimeout = setTimeout(() => fetchSuggestions(q), 300);
            } else {
                hideSuggestions();
            }
        });

        // ════════════════════════════════════════════════
        //  SEARCH SYSTEM  — guaranteed to work
        // ════════════════════════════════════════════════

        let currentQuery = '';

        function closePanel() {
            document.getElementById('searchPanel').style.display = 'none';
            searchResults.classList.remove('active');
        }

        function openPanel(query) {
            currentQuery = query;
            const panel = document.getElementById('searchPanel');
            const label = document.getElementById('panelLabel');
            const body  = document.getElementById('panelBody');
            label.textContent = '🔍 "' + query + '" search කරනවා...';
            body.innerHTML = `
                <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;gap:16px">
                    <div style="width:36px;height:36px;border:3px solid rgba(102,126,234,0.2);border-top-color:#667eea;border-radius:50%;animation:pnlSpin 0.75s linear infinite;"></div>
                    <div style="color:rgba(255,255,255,0.55);font-size:0.85rem;">Searching YouTube...</div>
                    <style>@keyframes pnlSpin{to{transform:rotate(360deg)}}</style>
                </div>`;
            panel.style.display = 'block';
            searchResults.classList.remove('active');
        }

        function showPanelResults(videos) {
            const body = document.getElementById('panelBody');
            const label = document.getElementById('panelLabel');
            if (!body) return;

            if (!videos || !videos.length) {
                label.textContent = '😔 Results load karanna bæ';
                body.innerHTML = `
                    <div style="padding:30px;text-align:center;color:rgba(255,255,255,0.4);font-size:0.85rem;line-height:1.8;">
                        වෙනත් song name ekak try karanna<br>
                        <span style="font-size:0.75rem;opacity:0.6;">හෝ YouTube URL paste කරන්න</span>
                    </div>`;
                return;
            }

            label.textContent = '🎵 ' + videos.length + ' results';
            body.innerHTML = '';

            videos.forEach(v => {
                const safe = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                const thumb = v.thumbnail || `https://i.ytimg.com/vi/${v.videoId}/mqdefault.jpg`;
                const card = document.createElement('div');
                card.style.cssText = 'display:flex;align-items:center;gap:12px;padding:11px 14px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.05);transition:background 0.15s;-webkit-tap-highlight-color:transparent;';
                card.innerHTML = `
                    <img src="${thumb}" style="width:68px;height:48px;border-radius:9px;object-fit:cover;flex-shrink:0;background:#1a1040;" loading="lazy" onerror="this.style.background='#1a1040';this.src='';">
                    <div style="flex:1;min-width:0;">
                        <div style="font-size:0.86rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:3px;color:white;">${safe(v.title)}</div>
                        <div style="font-size:0.74rem;color:rgba(255,255,255,0.42);">🎤 ${safe(v.author||v.uploaderName||'')}</div>
                    </div>
                    <button style="width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);border:none;color:white;font-size:0.82rem;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;">▶</button>
                `;
                card.addEventListener('mouseenter', () => card.style.background = 'rgba(102,126,234,0.18)');
                card.addEventListener('mouseleave', () => card.style.background = '');
                card.addEventListener('click', () => {
                    closePanel();
                    playYouTubeVideo(v.videoId, v.title, v.author||v.uploaderName||'');
                });
                body.appendChild(card);
            });
        }

        // Render results in the classic dropdown (fallback)
        function renderSearchResults(videos) {
            closePanel();
            searchResults.innerHTML = '';
            videos.slice(0, 10).forEach(video => {
                const thumb = video.thumbnail || video.videoThumbnails?.[4]?.url || video.videoThumbnails?.[0]?.url || `https://i.ytimg.com/vi/${video.videoId}/mqdefault.jpg`;
                const title = video.title || '';
                const author = video.author || video.uploaderName || '';
                const videoId = video.videoId || '';
                if (!videoId) return;
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `
                    <img class="result-thumb" src="${thumb}" alt="" onerror="this.style.background='#1a1040'">
                    <div class="result-info">
                        <div class="result-title">${title.replace(/</g,'&lt;')}</div>
                        <div class="result-channel">🎤 ${(author||'').replace(/</g,'&lt;')}</div>
                    </div>
                    <button class="result-play-btn">▶</button>
                `;
                const play = () => playYouTubeVideo(videoId, title, author);
                item.addEventListener('click', play);
                item.querySelector('.result-play-btn').addEventListener('click', e => { e.stopPropagation(); play(); });
                searchResults.appendChild(item);
            });
            searchResults.classList.add('active');
        }

        // ── Fetch helper ──
        function ft(url, ms) {
            const c = new AbortController();
            const t = setTimeout(() => c.abort(), ms || 6000);
            return fetch(url, { signal: c.signal })
                .then(r => { clearTimeout(t); return r; })
                .catch(e => { clearTimeout(t); throw e; });
        }

        // ── Parse YouTube HTML for video IDs/titles ──
        function parseYouTubeHTML(html) {
            const seen = new Set(), vids = [];
            try {
                const m = html.match(/var ytInitialData\s*=\s*(\{[\s\S]*?\});\s*(?:var |<\/script>)/);
                if (m) {
                    const obj = JSON.parse(m[1]);
                    const sect = (obj?.contents?.twoColumnSearchResultsRenderer
                        ?.primaryContents?.sectionListRenderer?.contents) || [];
                    for (const c of sect) {
                        for (const item of (c?.itemSectionRenderer?.contents || [])) {
                            const vr = item.videoRenderer;
                            if (!vr?.videoId || seen.has(vr.videoId)) continue;
                            seen.add(vr.videoId);
                            vids.push({
                                videoId: vr.videoId,
                                title: vr.title?.runs?.[0]?.text || '',
                                author: vr.ownerText?.runs?.[0]?.text || vr.shortBylineText?.runs?.[0]?.text || '',
                                thumbnail: `https://i.ytimg.com/vi/${vr.videoId}/mqdefault.jpg`,
                            });
                            if (vids.length >= 12) return vids;
                        }
                    }
                }
            } catch(e) {}
            // Regex fallback
            if (!vids.length) {
                const idMs = [...html.matchAll(/"videoId":"([a-zA-Z0-9_-]{11})"/g)];
                const titMs = [...html.matchAll(/"title":\{"runs":\[\{"text":"([^"]+)"\}/g)];
                let ti = 0;
                for (const mm of idMs) {
                    if (seen.has(mm[1])) continue;
                    seen.add(mm[1]);
                    vids.push({ videoId: mm[1], title: titMs[ti] ? titMs[ti++][1] : '', author: '', thumbnail: `https://i.ytimg.com/vi/${mm[1]}/mqdefault.jpg` });
                    if (vids.length >= 12) break;
                }
            }
            return vids.filter(v => v.videoId && v.title);
        }

        async function searchSongs(query) {
            hideSuggestions();
            const raw = query.trim();
            if (!raw) return;

            // Show panel with spinner immediately
            openPanel(raw);

            const q = encodeURIComponent(raw);
            const qSong = encodeURIComponent(raw + ' song');

            // ── Race all sources in parallel ──
            const invList = [
                'https://inv.nadeko.net',
                'https://invidious.nerdvpn.de',
                'https://invidious.privacydev.net',
                'https://yt.drgnz.club',
                'https://invidious.lunar.icu',
                'https://iv.datura.network',
                'https://invidious.io.lol',
                'https://invidious.fdn.fr',
                'https://inv.tux.pizza',
                'https://invidious.privacyredirect.com',
                'https://invidious.perennialte.ch',
                'https://iv.melmac.space',
            ];

            const pipedList = [
                'https://pipedapi.kavin.rocks',
                'https://api.piped.yt',
                'https://pipedapi.adminforge.de',
                'https://pipedapi.reallyaweso.me',
            ];

            const ytUrl = 'https://www.youtube.com/results?search_query=' + qSong;
            const proxyList = [
                'https://api.allorigins.win/get?url=' + encodeURIComponent(ytUrl),
                'https://corsproxy.io/?' + encodeURIComponent(ytUrl),
                'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(ytUrl),
                'https://thingproxy.freeboard.io/fetch/' + encodeURIComponent(ytUrl),
            ];

            // Invidious: race all in parallel
            const invRace = Promise.any(
                invList.map(b =>
                    ft(`${b}/api/v1/search?q=${qSong}&type=video`, 6000)
                    .then(r => r.ok ? r.json() : Promise.reject())
                    .then(d => Array.isArray(d) && d.length ? d.map(v => ({
                        videoId: v.videoId,
                        title: v.title,
                        author: v.author || v.uploaderName || '',
                        thumbnail: v.videoThumbnails?.[4]?.url || `https://i.ytimg.com/vi/${v.videoId}/mqdefault.jpg`,
                    })).filter(v => v.videoId && v.title) : Promise.reject())
                    .catch(() => Promise.reject())
                )
            ).catch(() => null);

            // Piped: try each
            const pipedRace = (async () => {
                for (const b of pipedList) {
                    try {
                        const r = await ft(`${b}/search?q=${qSong}&filter=music_songs`, 5000);
                        if (!r.ok) continue;
                        const data = await r.json();
                        const items = (data.items || []).filter(v => v.url && v.title);
                        if (!items.length) continue;
                        const vids = items.map(v => ({
                            videoId: v.url.replace('/watch?v=','').split('&')[0],
                            title: v.title,
                            author: v.uploaderName || '',
                            thumbnail: v.thumbnail || `https://i.ytimg.com/vi/${v.url.replace('/watch?v=','').split('&')[0]}/mqdefault.jpg`,
                        })).filter(v => v.videoId && v.videoId.length === 11 && v.title);
                        if (vids.length) return vids;
                    } catch(e) {}
                }
                return null;
            })();

            // CORS proxy scrape
            const proxyRace = (async () => {
                for (const p of proxyList) {
                    try {
                        const r = await ft(p, 9000);
                        if (!r.ok) continue;
                        let html = '';
                        if (p.includes('allorigins')) { const j = await r.json(); html = j.contents || ''; }
                        else html = await r.text();
                        if (!html || html.length < 500) continue;
                        const vids = parseYouTubeHTML(html);
                        if (vids.length >= 2) return vids;
                    } catch(e) {}
                }
                return null;
            })();

            // Take first to succeed
            try {
                const winner = await Promise.any([
                    invRace.then(d => d && d.length ? d : Promise.reject()),
                    pipedRace.then(d => d && d.length ? d : Promise.reject()),
                    proxyRace.then(d => d && d.length ? d : Promise.reject()),
                ]);
                if (winner && winner.length) {
                    showPanelResults(winner);
                    return;
                }
            } catch(e) {}

            // All failed
            showPanelResults([]);
        }

        // Stop all audio
        function stopAllAudio() {
            clearStreamKeepAlive();
            window.lastSongEnded = false;
            window.ytPlaying = false;
            if (isPlaying) {
                try { sourceNode.stop(); } catch(e) {}
                isPlaying = false;
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
            }
            if (window.previewAudio) {
                window.previewAudio.pause();
                window.previewAudio.src = '';
                window.previewAudio = null;
            }
            if (ytPlayer && ytReady) {
                try { ytPlayer.stopVideo(); } catch(e) {}
            }
        }

        // Play stream directly
        let streamRetryCount = 0;
        let streamKeepAliveTimer = null;
        let lastStreamUrl = null;
        let lastStreamTitle = '';
        let lastStreamArtist = '';

        function clearStreamKeepAlive() {
            if (streamKeepAliveTimer) {
                clearInterval(streamKeepAliveTimer);
                streamKeepAliveTimer = null;
            }
        }

        function playStreamSong(url, title, artist) {
            if (!url) {
                alert('❌ This song has no preview available. Try another!');
                return;
            }
            stopAllAudio();
            clearStreamKeepAlive();
            streamRetryCount = 0;
            lastStreamUrl = url;
            lastStreamTitle = title;
            lastStreamArtist = artist;
            window.lastSongEnded = false;

            songTitle.textContent = title;
            songStatus.textContent = `⏳ Loading...`;
            djAvatar.classList.add('active');
            searchResults.classList.remove('active');
            searchInput.value = title;

            const audio = new Audio();
            // NO crossOrigin - avoids CORS errors with JioSaavn streams
            audio.preload = 'none';
            audio.volume = 1.0;

            let hasStartedPlaying = false;

            audio.addEventListener('playing', () => {
                hasStartedPlaying = true;
                songStatus.textContent = `🎤 ${artist} ♪ Playing...`;
                djAvatar.classList.add('playing');
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
            });

            audio.addEventListener('waiting', () => {
                if (hasStartedPlaying) {
                    songStatus.textContent = `⏳ Buffering...`;
                }
            });

            audio.addEventListener('ended', () => {
                clearStreamKeepAlive();
                djAvatar.classList.remove('playing');
                songStatus.textContent = '🔁 Tap ▶ to replay';
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
                window.previewAudio = null;
                window.lastSongEnded = true;
            });

            audio.addEventListener('error', (e) => {
                // If already playing fine before, this is a mid-stream network blip
                // Try to recover silently without stopping
                if (hasStartedPlaying && streamRetryCount < 3) {
                    streamRetryCount++;
                    const savedTime = audio.currentTime;
                    songStatus.textContent = `⏳ Reconnecting...`;
                    // Re-assign src to force reload from same URL
                    setTimeout(() => {
                        if (window.previewAudio === audio) {
                            audio.src = url;
                            audio.currentTime = savedTime > 1 ? savedTime - 1 : 0;
                            audio.play().catch(() => {});
                        }
                    }, 1000);
                } else if (!hasStartedPlaying) {
                    // Failed before even starting — try iTunes preview as fallback
                    clearStreamKeepAlive();
                    djAvatar.classList.remove('playing');
                    songStatus.textContent = '❌ Stream failed. Try another song.';
                    playIcon.style.display = 'block';
                    pauseIcon.style.display = 'none';
                    window.previewAudio = null;
                }
            });

            audio.src = url;
            window.previewAudio = audio;

            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    // Playing started OK
                    playIcon.style.display = 'none';
                    pauseIcon.style.display = 'block';
                }).catch((err) => {
                    // Autoplay blocked or load error
                    djAvatar.classList.remove('playing');
                    songStatus.textContent = '❌ Playback failed. Try another song.';
                    playIcon.style.display = 'block';
                    pauseIcon.style.display = 'none';
                });
            }
        }

        function openYouTubeSearch(query) {
            window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`, '_blank');
        }

        function showYouTubeOption(query) {
            searchResults.innerHTML = `<div class="search-loading">😔 No results found for "${query}"</div>`;
        }

        function playFromPastedUrl() {
            const input = document.getElementById('ytUrlPaste');
            const url = input?.value?.trim() || '';
            const match = url.match(/(?:v=|youtu\.be\/|shorts\/)([^&\s?]+)/);
            if (match) {
                playYouTubeVideo(match[1], 'YouTube Song', '');
            } else {
                alert('❌ Valid YouTube URL paste කරන්න!');
            }
        }

        function playYouTubeVideo(videoId, title, author) {
            // Stop any stream audio first
            if (window.previewAudio) {
                window.previewAudio.pause();
                window.previewAudio.src = '';
                window.previewAudio = null;
            }
            clearStreamKeepAlive();

            // Save for replay
            lastStreamUrl = null;
            lastStreamTitle = title;
            lastStreamArtist = author;
            window.lastYtVideoId = videoId;
            window.lastSongEnded = false;
            window.ytPlaying = false;

            songTitle.textContent = title;
            songStatus.textContent = '⏳ Loading...';
            djAvatar.classList.add('active');
            searchResults.classList.remove('active');
            searchInput.value = title;
            playIcon.style.display = 'none';
            pauseIcon.style.display = 'block';

            if (!ytReady || !ytPlayer) {
                // Player not ready yet - wait and retry
                songStatus.textContent = '⏳ Player loading...';
                setTimeout(() => playYouTubeVideo(videoId, title, author), 1500);
                return;
            }

            ytPlayer.loadVideoById(videoId);
        }

        // Search on button click
        searchBtn.addEventListener('click', () => {
            const q = searchInput.value.trim();
            hideSuggestions();
            if (q) searchSongs(q);
        });

        // Close on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#searchSection') && !e.target.closest('#searchPanel')) {
                hideSuggestions();
                searchResults.classList.remove('active');
                closePanel();
            }
        });


    </script>

    <!-- Owner Panel -->
    <div class="owner-panel" id="ownerPanel">
        <div class="owner-login-form" id="ownerLoginForm">
            <div class="owner-code-box">
                <input type="password" class="owner-code-input" id="ownerCodeInput" placeholder="🔑 Enter access code...">
                <button class="owner-unlock-btn" id="ownerSubmit">🔓 Unlock</button>
            </div>
            <div class="owner-error" id="ownerError">❌ Wrong code! Try again.</div>
        </div>
        <div class="owner-dashboard" id="ownerDashboard">
            <div class="owner-dash-title">👑 Welcome, Sanithu!</div>

            <!-- STATS -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalViews">0</div>
                    <div class="stat-label">👁️ Total Views</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayViews">0</div>
                    <div class="stat-label">📅 Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">0</div>
                    <div class="stat-label">👤 Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSearches">0</div>
                    <div class="stat-label">🔍 Searches</div>
                </div>
            </div>

            <!-- OWNER TABS -->
            <div class="owner-tabs">
                <button class="owner-tab active" onclick="ownerTab('announce')">📢 Announce</button>
                <button class="owner-tab" onclick="ownerTab('chat')">💬 Chat</button>
                <button class="owner-tab" onclick="ownerTab('users')">🚫 Users</button>
                <button class="owner-tab" onclick="ownerTab('visitors')">📊 Visitors</button>
            </div>

            <!-- TAB: ANNOUNCEMENT -->
            <div class="owner-tab-content active" id="tab-announce">
                <div class="owner-section-title">📢 Send Announcement</div>
                <textarea id="announceText" class="owner-textarea" placeholder="Type your announcement to all visitors..." maxlength="200"></textarea>
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <button class="owner-action-btn green" onclick="sendAnnouncement()">📤 Send to All</button>
                    <button class="owner-action-btn red" onclick="clearAnnouncement()">🗑️ Clear</button>
                </div>
                <div id="announceStatus" style="font-size:0.75rem;margin-top:6px;color:#2ed573;display:none;">✅ Announcement sent!</div>
            </div>

            <!-- TAB: CHAT -->
            <div class="owner-tab-content" id="tab-chat">
                <div class="owner-section-title">💬 Chat Management</div>
                <div id="chatMsgCount" style="font-size:0.8rem;color:rgba(255,255,255,0.6);margin-bottom:10px;">Loading...</div>
                <button class="owner-action-btn red" onclick="ownerClearChat()" style="width:100%;">🗑️ Clear All Messages</button>
                <div style="margin-top:10px;font-size:0.75rem;color:rgba(255,255,255,0.4);">Auto-clear: Every 20 minutes</div>
            </div>

            <!-- TAB: USER BAN -->
            <div class="owner-tab-content" id="tab-users">
                <div class="owner-section-title">🚫 Online Users</div>
                <div id="onlineUsersList" style="max-height:150px;overflow-y:auto;">
                    <div style="color:rgba(255,255,255,0.4);font-size:0.8rem;">Loading users...</div>
                </div>
            </div>

            <!-- TAB: VISITORS MAP -->
            <div class="owner-tab-content" id="tab-visitors">
                <div class="owner-section-title">📊 Live Visitors</div>
                <div id="visitorsList" style="max-height:160px;overflow-y:auto;">
                    <div style="color:rgba(255,255,255,0.4);font-size:0.8rem;">Loading...</div>
                </div>
                <div style="font-size:0.72rem;color:rgba(255,255,255,0.3);margin-top:8px;">* Location based on IP (approximate)</div>
            </div>

            <div class="owner-dash-btns">
                <button class="owner-logout" onclick="ownerLogout()">🚪 Logout</button>
                <button class="owner-close-dash" onclick="closeOwnerPanel()">✖ Close</button>
            </div>
        </div>
    </div>
    <button class="owner-btn" id="ownerBtn">🔐 Owner</button>


    <!-- ===== LIVE CHAT ===== -->
    <button class="chat-toggle-btn" id="chatToggleBtn" title="Live Chat" onclick="toggleChat()">
        &#x1F4AC;
        <div class="chat-badge" id="chatBadge">0</div>
    </button>
    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <div class="chat-header-dot"></div>
            <div>
                <div class="chat-header-title">Live Chat &#x1F4AC;</div>
                <div class="chat-header-sub" id="chatOnlineCount">&#x1F504; Connecting...</div>
            </div>
            <button class="chat-close-btn" onclick="toggleChat()">&#x2715;</button>
        </div>
        <div class="chat-name-prompt" id="chatNamePrompt">
            <p>&#x1F44B; Chat join karanna<br>uyaata name ekak denne!</p>
            <input type="text" class="chat-name-input" id="chatNameInput" placeholder="Uyage name..." maxlength="20">
            <button class="chat-name-btn" onclick="joinChat()">&#x1F680; Join Chat</button>
        </div>
        <div id="chatMain" style="display:none; flex-direction:column; flex:1; overflow:hidden;">
            <div class="chat-messages" id="chatMessages"></div>
            <div class="emoji-picker" id="emojiPicker">
                <div class="emoji-tabs" id="emojiTabs"></div>
                <div class="emoji-grid" id="emojiGrid"></div>
            </div>
            <div class="chat-input-area">
                <button class="emoji-toggle-btn" id="emojiToggleBtn" onclick="toggleEmojiPicker()" title="Emoji">&#x1F60A;</button>
                <input type="text" class="chat-input" id="chatInput" placeholder="Message type karanna..." maxlength="300">
                <button class="chat-send-btn" onclick="sendMessage()">&#x27A4;</button>
            </div>
            <div class="chat-footer-name" id="chatFooterName"></div>
        </div>
    </div>

    <script>
    // ===== FIREBASE REST API CHAT =====
    var FBURL = "https://my-immersive-space-82cbd-default-rtdb.firebaseio.com";
    var myName = localStorage.getItem('chat_my_name') || '';
    var myId = localStorage.getItem('chat_my_id') || ('u_' + Math.random().toString(36).slice(2,10));
    localStorage.setItem('chat_my_id', myId);
    var chatOpen = false;
    var unreadCount = 0;
    var pollTimer = null;
    var chatStarted = false;
    var renderedKeys = window.renderedKeys = new Set();

    window.toggleChat = function() {
        chatOpen = !chatOpen;
        document.getElementById('chatWindow').classList.toggle('active', chatOpen);
        if (chatOpen) {
            unreadCount = 0; updateBadge();
            if (myName && !chatStarted) startChat();
            setTimeout(function() { scrollBottom(); if(myName){ var i=document.getElementById('chatInput'); if(i) i.focus(); } }, 100);
        }
    };

    window.joinChat = function() {
        var inp = document.getElementById('chatNameInput');
        var name = (inp.value||'').trim().replace(/[<>]/g,'').slice(0,20);
        if (!name) { inp.style.borderColor='#ff4757'; setTimeout(function(){inp.style.borderColor='';},1000); inp.focus(); return; }
        myName = name;
        localStorage.setItem('chat_my_name', name);
        document.getElementById('chatNamePrompt').style.display = 'none';
        var cm=document.getElementById('chatMain'); cm.style.display='flex'; cm.style.flexDirection='column'; cm.style.flex='1'; cm.style.overflow='hidden';
        updateFooter();
        startChat();
        var ci = document.getElementById('chatInput'); if(ci) ci.focus();
    };

    function startChat() {
        if (chatStarted) return;
        chatStarted = true;
        setPresence();
        setInterval(setPresence, 20000);
        pushMsg('system','System', myName + ' joined the chat &#x1F44B;');
        loadMessages(true);
        pollTimer = setInterval(function(){ loadMessages(false); }, 2500);
        updateOnlineCount();
        setInterval(updateOnlineCount, 5000);
    }

    function setPresence() {
        fetch(FBURL+'/chat/presence/'+myId+'.json',{method:'PUT',body:JSON.stringify({name:myName,ts:Date.now(),fp:typeof _getFingerprint==='function'?_getFingerprint():''})}).catch(function(){});
        fetch(FBURL+'/chat/presence.json').then(function(r){return r.json();}).then(function(d){
            if(!d) return;
            var now=Date.now();
            Object.entries(d).forEach(function(e){
                if(now-(e[1].ts||0)>35000) fetch(FBURL+'/chat/presence/'+e[0]+'.json',{method:'DELETE'}).catch(function(){});
            });
        }).catch(function(){});
    }

    function updateOnlineCount() {
        fetch(FBURL+'/chat/presence.json').then(function(r){return r.json();}).then(function(d){
            var c = d ? Object.keys(d).length : 0;
            var el = document.getElementById('chatOnlineCount');
            if(el) el.textContent = '&#x1F7E2; '+c+' online';
        }).catch(function(){ var el=document.getElementById('chatOnlineCount'); if(el) el.textContent='&#x1F534; Offline'; });
    }

    window.sendMessage = function() {
        if (!myName) return;
        var inp = document.getElementById('chatInput');
        var text = (inp.value||'').trim();
        if (!text) return;
        inp.value = '';
        pushMsg('user', myName, text);
    };

    function pushMsg(type, name, text) {
        fetch(FBURL+'/chat/messages.json',{method:'POST',body:JSON.stringify({type:type,name:name,text:text,userId:myId,ts:Date.now()})}).catch(function(){});
    }

    function loadMessages(initial) {
        fetch(FBURL+'/chat/messages.json?orderBy="ts"&limitToLast=60').then(function(r){return r.json();}).then(function(data){
            if(!data) return;
            var msgs = Object.entries(data).map(function(e){ return Object.assign({key:e[0]},e[1]); }).sort(function(a,b){return (a.ts||0)-(b.ts||0);});
            msgs.forEach(function(msg){
                if(!renderedKeys.has(msg.key)){
                    renderedKeys.add(msg.key);
                    renderMsg(msg, msg.userId===myId);
                    if(!chatOpen && msg.userId!==myId){ unreadCount++; updateBadge(); }
                    scrollBottom();
                }
            });
        }).catch(function(){});
    }

    function renderMsg(msg, isOwn) {
        var box = document.getElementById('chatMessages'); if(!box) return;
        var d = document.createElement('div');
        d.className = 'chat-msg '+(msg.type==='system'?'system':isOwn?'own':'other');
        var t = msg.ts ? new Date(msg.ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '';
        var e = function(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');};
        if(msg.type==='system'){
            d.innerHTML='<div class="chat-msg-bubble">'+e(msg.text)+'</div>';
        } else {
            d.innerHTML=(!isOwn?'<div class="chat-msg-name">'+e(msg.name)+'</div>':'')+
                '<div class="chat-msg-bubble">'+e(msg.text)+'</div>'+
                '<div class="chat-msg-time">'+t+'</div>';
        }
        box.appendChild(d);
    }

    function scrollBottom(){ var el=document.getElementById('chatMessages'); if(el) el.scrollTop=el.scrollHeight; }

    function updateBadge(){
        var b=document.getElementById('chatBadge'); if(!b) return;
        if(unreadCount>0&&!chatOpen){b.textContent=unreadCount>9?'9+':unreadCount;b.classList.add('show');}
        else b.classList.remove('show');
    }

    function updateFooter(){
        var el=document.getElementById('chatFooterName');
        var e=function(s){return String(s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');};
        if(el) el.innerHTML='Chatting as <span onclick="changeName()" style="color:#667eea;cursor:pointer;">@'+e(myName)+'</span>';
    }

    window.changeName = function(){
        var n=prompt('New name:',myName); if(!n||!n.trim()) return;
        var old=myName; myName=n.trim().replace(/[<>]/g,'').slice(0,20);
        localStorage.setItem('chat_my_name',myName); updateFooter();
        setPresence(); pushMsg('system','System',old+' is now '+myName+' &#x270F;&#xFE0F;');
    };

    document.addEventListener('keydown', function(e){
        if(e.key==='Enter'&&document.activeElement===document.getElementById('chatInput')) sendMessage();
        if(e.key==='Enter'&&document.activeElement===document.getElementById('chatNameInput')) joinChat();
    });

    if(myName){
        var np=document.getElementById('chatNamePrompt'); if(np) np.style.display='none';
        var cm=document.getElementById('chatMain'); if(cm){ cm.style.display='flex'; cm.style.flexDirection='column'; cm.style.flex='1'; cm.style.overflow='hidden'; }
        updateFooter();
    }
    updateOnlineCount();
    </script>

    <script>
    // ===== EMOJI PICKER =====
    (function(){
        var CATS=[
            {icon:'&#x1F600;',emojis:['&#x1F600;','&#x1F601;','&#x1F602;','&#x1F923;','&#x1F603;','&#x1F604;','&#x1F605;','&#x1F606;','&#x1F609;','&#x1F60A;','&#x1F60B;','&#x1F60E;','&#x1F60D;','&#x1F970;','&#x1F618;','&#x1F642;','&#x1F917;','&#x1F929;','&#x1F914;','&#x1F610;','&#x1F644;','&#x1F60F;','&#x1F625;','&#x1F62E;','&#x1F62F;','&#x1F62A;','&#x1F62B;','&#x1F634;','&#x1F60C;','&#x1F61B;','&#x1F61C;','&#x1F61D;','&#x1F612;','&#x1F613;','&#x1F614;','&#x1F615;','&#x1F643;','&#x1F911;','&#x1F632;','&#x1F616;','&#x1F61E;','&#x1F61F;','&#x1F624;','&#x1F622;','&#x1F62D;','&#x1F628;','&#x1F629;','&#x1F92F;','&#x1F62C;','&#x1F630;','&#x1F631;','&#x1F975;','&#x1F976;','&#x1F633;','&#x1F92A;','&#x1F635;','&#x1F620;','&#x1F621;','&#x1F92C;','&#x1F637;','&#x1F912;','&#x1F915;','&#x1F922;','&#x1F92E;','&#x1F927;','&#x1F607;','&#x1F973;','&#x1F97A;']},
            {icon:'&#x1F44D;',emojis:['&#x1F44B;','&#x270B;','&#x1F590;','&#x1F596;','&#x1F44C;','&#x270C;','&#x1F91E;','&#x1F91F;','&#x1F918;','&#x1F919;','&#x1F448;','&#x1F449;','&#x1F446;','&#x1F447;','&#x261D;','&#x1F44D;','&#x1F44E;','&#x270A;','&#x1F44A;','&#x1F91B;','&#x1F91C;','&#x1F44F;','&#x1F64C;','&#x1F450;','&#x1F91D;','&#x1F64F;','&#x270D;','&#x1F485;','&#x1F4AA;','&#x1F440;','&#x1F445;','&#x1F444;','&#x1F48B;']},
            {icon:'&#x2764;',emojis:['&#x2764;','&#x1F9E1;','&#x1F49B;','&#x1F49A;','&#x1F499;','&#x1F49C;','&#x1F5A4;','&#x1F90D;','&#x1F90E;','&#x1F494;','&#x2763;','&#x1F495;','&#x1F49E;','&#x1F493;','&#x1F497;','&#x1F496;','&#x1F498;','&#x1F49D;','&#x1F525;','&#x2728;','&#x2B50;','&#x1F31F;','&#x1F4AB;','&#x26A1;','&#x1F308;','&#x2600;','&#x2744;','&#x1F30A;','&#x1F4AF;','&#x267E;','&#x1F3B5;','&#x1F3B6;']},
            {icon:'&#x1F389;',emojis:['&#x1F389;','&#x1F38A;','&#x1F388;','&#x1F381;','&#x1F380;','&#x1F382;','&#x1F370;','&#x1F9C1;','&#x1F942;','&#x1F37E;','&#x1F386;','&#x1F387;','&#x1F9E8;','&#x2728;','&#x1F3AF;','&#x1F3AE;','&#x1F579;','&#x1F3B2;','&#x1F3AD;','&#x1F3A8;','&#x1F3A4;','&#x1F3A7;','&#x1F3B5;','&#x1F3B6;','&#x1F3B8;','&#x1F3B9;','&#x1F941;','&#x1F3B7;','&#x1F3BA;','&#x1F3BB;','&#x1F3AC;','&#x1F52E;','&#x1FA84;','&#x1F3C6;','&#x1F947;','&#x1F948;','&#x1F949;']},
            {icon:'&#x1F436;',emojis:['&#x1F436;','&#x1F431;','&#x1F42D;','&#x1F439;','&#x1F430;','&#x1F98A;','&#x1F43B;','&#x1F43C;','&#x1F428;','&#x1F42F;','&#x1F981;','&#x1F42E;','&#x1F437;','&#x1F438;','&#x1F435;','&#x1F648;','&#x1F649;','&#x1F64A;','&#x1F414;','&#x1F427;','&#x1F426;','&#x1F424;','&#x1F985;','&#x1F989;','&#x1F98B;','&#x1F40C;','&#x1F41E;','&#x1F422;','&#x1F40D;','&#x1F98E;','&#x1F419;','&#x1F991;','&#x1F420;','&#x1F41F;','&#x1F42C;','&#x1F433;','&#x1F988;','&#x1F40A;','&#x1F992;','&#x1F418;','&#x1F993;','&#x1F415;','&#x1F408;','&#x1F407;','&#x1F994;']},
            {icon:'&#x1F355;',emojis:['&#x1F355;','&#x1F354;','&#x1F32E;','&#x1F32F;','&#x1F957;','&#x1F35C;','&#x1F35D;','&#x1F35B;','&#x1F371;','&#x1F363;','&#x1F364;','&#x1F359;','&#x1F35A;','&#x1F382;','&#x1F370;','&#x1F9C1;','&#x1F369;','&#x1F36A;','&#x1F36B;','&#x1F36C;','&#x1F36D;','&#x1F34E;','&#x1F34A;','&#x1F34B;','&#x1F347;','&#x1F353;','&#x1FAD0;','&#x1F351;','&#x1F96D;','&#x1F34D;','&#x1F965;','&#x1F95D;','&#x1F345;','&#x1F951;','&#x1F33D;','&#x1F955;','&#x1F9C4;','&#x1F35E;','&#x1F373;','&#x1F95E;','&#x1F953;','&#x1F357;','&#x1F32D;','&#x1F96A;','&#x1F37F;','&#x2615;','&#x1F964;','&#x1F37A;','&#x1F37B;','&#x1F942;','&#x1F377;','&#x1F379;']},
            {icon:'&#x26BD;',emojis:['&#x26BD;','&#x1F3C0;','&#x1F3C8;','&#x26BE;','&#x1F94E;','&#x1F3BE;','&#x1F3D0;','&#x1F3C9;','&#x1F3B1;','&#x1F3D3;','&#x1F3F8;','&#x1F94A;','&#x1F94B;','&#x1F3BD;','&#x1F6F9;','&#x26F8;','&#x1F3BF;','&#x1F3CB;','&#x1F938;','&#x1F3C4;','&#x1F3CA;','&#x1F6B4;','&#x1F3C6;','&#x1F947;','&#x1F948;','&#x1F949;','&#x1F3C5;','&#x1F396;']},
            {icon:'&#x1F30D;',emojis:['&#x1F30D;','&#x1F30E;','&#x1F30F;','&#x1F5FA;','&#x1F3D4;','&#x1F30B;','&#x1F3D5;','&#x1F3D6;','&#x1F3DC;','&#x1F3DD;','&#x1F3E0;','&#x1F3E1;','&#x1F3E2;','&#x1F3E8;','&#x1F3EA;','&#x1F3EB;','&#x1F3EC;','&#x1F3EF;','&#x1F3F0;','&#x1F492;','&#x1F5FC;','&#x1F5FD;','&#x26EA;','&#x26F2;','&#x26FA;','&#x1F303;','&#x1F306;','&#x1F307;','&#x1F308;','&#x1F682;','&#x1F697;','&#x1F695;','&#x1F699;','&#x1F3CE;','&#x1F681;','&#x2708;','&#x1F680;','&#x1F6F8;','&#x26F5;','&#x1F6A2;','&#x1F6F3;']}
        ];
        var open=false,built=false;
        window.toggleEmojiPicker=function(){
            open=!open;
            var p=document.getElementById('emojiPicker'),b=document.getElementById('emojiToggleBtn');
            if(!p) return;
            if(open&&!built){built=true;buildPicker();}
            p.classList.toggle('active',open);
            if(b) b.classList.toggle('active',open);
        };
        function buildPicker(){
            var tabs=document.getElementById('emojiTabs'),grid=document.getElementById('emojiGrid');
            if(!tabs||!grid) return;
            tabs.innerHTML='';
            CATS.forEach(function(c,i){
                var b=document.createElement('button');
                b.className='emoji-tab'+(i===0?' active':'');
                b.innerHTML=c.icon; b.onclick=function(){switchCat(i);};
                tabs.appendChild(b);
            });
            renderCat(0);
        }
        function renderCat(idx){
            var g=document.getElementById('emojiGrid'); if(!g) return;
            g.innerHTML='';
            CATS[idx].emojis.forEach(function(em){
                var b=document.createElement('button');
                b.className='emoji-item'; b.innerHTML=em;
                b.onclick=function(){
                    var inp=document.getElementById('chatInput'); if(!inp) return;
                    var s=inp.selectionStart,e2=inp.selectionEnd;
                    inp.value=inp.value.slice(0,s)+b.textContent+inp.value.slice(e2);
                    inp.selectionStart=inp.selectionEnd=s+b.textContent.length;
                    inp.focus();
                };
                g.appendChild(b);
            });
            g.scrollTop=0;
        }
        function switchCat(idx){
            document.querySelectorAll('.emoji-tab').forEach(function(t,i){t.classList.toggle('active',i===idx);});
            renderCat(idx);
        }
        document.addEventListener('click',function(e){
            if(!e.target.closest('#emojiPicker')&&!e.target.closest('#emojiToggleBtn')){
                var p=document.getElementById('emojiPicker'),b=document.getElementById('emojiToggleBtn');
                if(p) p.classList.remove('active'); if(b) b.classList.remove('active'); open=false;
            }
        },true);
    })();
    </script>

    <script>
    // ===== AUTO CLEAR CHAT EVERY 20 MINUTES =====
    (function(){
        var FBURL2="https://my-immersive-space-82cbd-default-rtdb.firebaseio.com";
        var CLEAR_MS=20*60*1000;
        var LAST_KEY='chat_last_cleared';
        function clearChat(){
            fetch(FBURL2+'/chat/messages.json',{method:'DELETE'}).then(function(){
                localStorage.setItem(LAST_KEY,Date.now());
                setTimeout(function(){
                    fetch(FBURL2+'/chat/messages.json',{method:'POST',body:JSON.stringify({type:'system',name:'System',text:'Chat cleared! Fresh start.',userId:'system',ts:Date.now()})});
                    var box=document.getElementById('chatMessages'); if(box) box.innerHTML='';
                    if(window.renderedKeys) window.renderedKeys.clear();
                },500);
            }).catch(function(){});
        }
        function check(){
            var last=parseInt(localStorage.getItem(LAST_KEY)||'0');
            if(Date.now()-last>=CLEAR_MS) clearChat();
        }
        check();
        setInterval(check,60000);
    })();
    </script>

    <script>
    // ===== SECURITY =====
    (function(){
        document.addEventListener('contextmenu',function(e){e.preventDefault();});
        document.addEventListener('keydown',function(e){
            if(e.key==='F12'){e.preventDefault();return false;}
            if(e.ctrlKey&&e.shiftKey&&(e.key==='I'||e.key==='J'||e.key==='C')){e.preventDefault();return false;}
            if(e.ctrlKey&&(e.key==='u'||e.key==='U'||e.key==='s'||e.key==='S')){e.preventDefault();return false;}
        });
        var devOpen=false;
        function checkDev(){
            var w=window.outerWidth-window.innerWidth,h=window.outerHeight-window.innerHeight;
            if(w>160||h>160){if(!devOpen){devOpen=true;showBlock();}}
            else{if(devOpen){devOpen=false;var o=document.getElementById('secOverlay');if(o)o.remove();}}
        }
        function showBlock(){
            if(document.getElementById('secOverlay')) return;
            var o=document.createElement('div');
            o.id='secOverlay';
            o.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:2147483647;display:flex;align-items:center;justify-content:center;color:white;font-family:monospace;text-align:center;';
            o.innerHTML='<div><div style="font-size:4rem">&#x1F6A8;</div><div style="font-size:2rem;color:#ff4757;font-weight:900;margin:15px 0">ACCESS DENIED</div><div style="color:rgba(255,255,255,0.6)">Close DevTools to continue.</div></div>';
            document.body.appendChild(o);
        }
        setInterval(checkDev,1000);
        try{console.log('%c STOP!','color:red;font-size:40px;font-weight:bold;');}catch(e){}
        try{console.log('%cProtected by Sanithu','color:gold;font-size:14px;');}catch(e){}
        var stamps=[];
        // Spam protection - wrap sendMessage after all scripts loaded
        window.addEventListener('load', function() {
            var origSend = window.sendMessage;
            window.sendMessage = function(){
                var now=Date.now();
                stamps=stamps.filter(function(t){return now-t<10000;});
                if(stamps.length>=5){
                    var inp=document.getElementById('chatInput');
                    if(inp){inp.placeholder='Too fast! Wait...';inp.style.borderColor='#ff4757';setTimeout(function(){inp.placeholder='Message type karanna...';inp.style.borderColor='';},2000);}
                    return;
                }
                stamps.push(now);
                if(origSend) origSend();
            };
        });
        document.addEventListener('selectstart',function(e){
            if(e.target.tagName!=='INPUT'&&e.target.tagName!=='TEXTAREA') e.preventDefault();
        });
    })();
    </script>



    <script>
    // ===== OWNER PANEL =====
    (function() {
        var today = new Date().toDateString();
        var total = parseInt(localStorage.getItem('site_total_views') || '0') + 1;
        localStorage.setItem('site_total_views', total);
        var todayCount = parseInt(localStorage.getItem('site_today_views') || '0');
        if (localStorage.getItem('site_last_date') !== today) { todayCount = 0; localStorage.setItem('site_last_date', today); }
        localStorage.setItem('site_today_views', ++todayCount);
        localStorage.setItem('site_last_date', today);

        var _0xA1B2 = "908c7494748d9e84"+"1f4bb5cece9c8a10"+"b4f39307568f064f"+"53d796140f098809";
        var _0xC3D4 = atob("bVc5eCNrUDIkdkw3QG5RNCZqUjYhYlQ4XmhZMypjRjU=");

        var _0xE5F6 = parseInt(sessionStorage.getItem(atob("X293X2F0dA=="))||'0');
        var _0xG7H8 = parseInt(sessionStorage.getItem(atob("X293X2xjaw=="))||'0');

        function _isLocked() {
            if (_0xG7H8 && Date.now() < _lck) return true;
            if (_0xG7H8 && Date.now() >= _lck) { _att=0; _lck=0; sessionStorage.removeItem(atob("X293X2F0dA==")); sessionStorage.removeItem(atob("X293X2xjaw==")); }
            return false;
        }
        function _fail() {
            _0xE5F6++; sessionStorage.setItem(atob("X293X2F0dA=="), _att);
            if (_0xE5F6 >= 5) { _0xG7H8 = Date.now() + 15*60*1000; sessionStorage.setItem(atob("X293X2xjaw=="), _lck); }
        }
        function _resetAtt() { _att=0; _lck=0; sessionStorage.removeItem(atob("X293X2F0dA==")); sessionStorage.removeItem(atob("X293X2xjaw==")); }

        async function _sha256(str) {
            var buf = new TextEncoder().encode(str);
            var hbuf = await crypto.subtle.digest('SHA-256', buf);
            return Array.from(new Uint8Array(hbuf)).map(b=>b.toString(16).padStart(2,'0')).join('');
        }
        async function _verify(input) {
            var h1 = await _sha256(input);
            var h2 = await _sha256(h1 + _0xC3D4);
            return h2 === _0xA1B2;
        }

        function init() {
            var ownerBtn = document.getElementById('ownerBtn');
            var ownerPanel = document.getElementById('ownerPanel');
            var ownerLoginForm = document.getElementById('ownerLoginForm');
            var ownerDashboard = document.getElementById('ownerDashboard');
            var ownerCodeInput = document.getElementById('ownerCodeInput');
            var ownerSubmit = document.getElementById('ownerSubmit');
            var ownerError = document.getElementById('ownerError');

            if (!ownerBtn || !ownerPanel) return;

            ownerBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (ownerPanel.classList.contains('active')) {
                    ownerPanel.classList.remove('active');
                } else {
                    ownerPanel.classList.add('active');
                    ownerCodeInput.value = '';
                    ownerError.classList.remove('show');
                    if (sessionStorage.getItem(atob("X293X29r")) === '1') {
                        showDash();
                    } else {
                        ownerLoginForm.classList.remove('hidden');
                        ownerDashboard.classList.remove('active');
                    }
                    setTimeout(function() { ownerCodeInput.focus(); }, 150);
                }
            });

            ownerSubmit.addEventListener('click', check);
            ownerCodeInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') check();
                if (e.key === 'Escape') ownerPanel.classList.remove('active');
            });

            async function check() {
                var input = ownerCodeInput.value.trim();
                if (!input) return;
                if (_isLocked()) {
                    var mins = Math.ceil((_0xG7H8 - Date.now()) / 60000);
                    ownerError.textContent = 'Too many attempts! Wait ' + mins + ' min.';
                    ownerError.classList.add('show');
                    ownerCodeInput.value = '';
                    return;
                }
                ownerSubmit.disabled = true;
                ownerSubmit.textContent = 'Checking...';
                try {
                    var ok = await _verify(input);
                    if (ok) {
                        _resetAtt();
                        sessionStorage.setItem(atob("X293X29r"), '1');
                        ownerError.classList.remove('show');
                        showDash();
                    } else {
                        _fail();
                        ownerError.textContent = _isLocked() ? 'Locked 15 min!' : 'Wrong! ' + (5 - _0xE5F6) + ' left.';
                        ownerError.classList.add('show');
                        ownerCodeInput.value = '';
                        ownerCodeInput.style.borderColor = '#ff6b6b';
                        setTimeout(function() { ownerCodeInput.style.borderColor = ''; }, 1000);
                        ownerCodeInput.focus();
                    }
                } catch(e) {
                    ownerError.textContent = 'Error! Try again.';
                    ownerError.classList.add('show');
                    ownerCodeInput.value = '';
                } finally {
                    ownerSubmit.disabled = false;
                    ownerSubmit.textContent = 'Unlock';
                }
            }

            function showDash() {
                ownerLoginForm.classList.add('hidden');
                ownerDashboard.classList.add('active');
                anim('totalViews', parseInt(localStorage.getItem('site_total_views') || '0'));
                anim('todayViews', parseInt(localStorage.getItem('site_today_views') || '0'));
                anim('totalUsers', JSON.parse(localStorage.getItem('users') || '[]').length);
                anim('totalSearches', parseInt(localStorage.getItem('site_total_searches') || '0'));
            }

            function anim(id, target) {
                var el = document.getElementById(id);
                if (!el) return;
                var cur = 0;
                var step = Math.max(1, Math.floor(target / 25));
                var t = setInterval(function() {
                    cur = Math.min(cur + step, target);
                    el.textContent = cur.toLocaleString();
                    if (cur >= target) clearInterval(t);
                }, 40);
            }

            window.ownerLogout = function() {
                sessionStorage.removeItem(atob("X293X29r"));
                ownerDashboard.classList.remove('active');
                ownerLoginForm.classList.remove('hidden');
                ownerCodeInput.value = '';
            };

            window.closeOwnerPanel = function() {
                ownerPanel.classList.remove('active');
            };

            document.addEventListener('click', function(e) {
                if (!e.target.closest('#ownerPanel') && !e.target.closest('#ownerBtn')) {
                    ownerPanel.classList.remove('active');
                }
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    })();
    </script>


    <script>
    // ===== OWNER PANEL FEATURES =====
    var FBURL_OWNER = "https://my-immersive-space-82cbd-default-rtdb.firebaseio.com";

    // ===== TAB SWITCHING =====
    window.ownerTab = function(tab) {
        document.querySelectorAll('.owner-tab').forEach(function(t){ t.classList.remove('active'); });
        document.querySelectorAll('.owner-tab-content').forEach(function(c){ c.classList.remove('active'); });
        var tabEl = document.querySelector('.owner-tab[onclick="ownerTab(\''+tab+'\')"]');
        if (tabEl) tabEl.classList.add('active');
        var content = document.getElementById('tab-'+tab);
        if (content) content.classList.add('active');

        if (tab === 'users') loadOnlineUsers();
        if (tab === 'visitors') loadVisitors();
        if (tab === 'chat') loadChatCount();
    };

    // ===== ANNOUNCEMENT =====
    window.sendAnnouncement = function() {
        var text = (document.getElementById('announceText').value || '').trim();
        if (!text) return;
        fetch(FBURL_OWNER + '/announcement.json', {
            method: 'PUT',
            body: JSON.stringify({ text: text, ts: Date.now(), active: true })
        }).then(function() {
            var status = document.getElementById('announceStatus');
            if (status) { status.style.display = 'block'; setTimeout(function(){ status.style.display='none'; }, 3000); }
            showAnnouncementBanner(text);
        }).catch(function(){});
    };

    window.clearAnnouncement = function() {
        fetch(FBURL_OWNER + '/announcement.json', { method: 'DELETE' }).then(function() {
            hideBanner();
            var inp = document.getElementById('announceText');
            if (inp) inp.value = '';
        }).catch(function(){});
    };

    window.dismissAnnouncement = function() { hideBanner(); };

    function showAnnouncementBanner(text) {
        var banner = document.getElementById('announceBanner');
        var bannerText = document.getElementById('announceBannerText');
        if (!banner || !bannerText) return;
        bannerText.textContent = '📢 ' + text;
        banner.classList.add('show');
    }

    function hideBanner() {
        var banner = document.getElementById('announceBanner');
        if (banner) banner.classList.remove('show');
    }

    // Check announcement on load & poll
    function checkAnnouncement() {
        fetch(FBURL_OWNER + '/announcement.json').then(function(r){ return r.json(); }).then(function(d) {
            if (d && d.active && d.text) {
                if (!sessionStorage.getItem('ann_dismissed_' + d.ts)) {
                    showAnnouncementBanner(d.text);
                }
            } else {
                hideBanner();
            }
        }).catch(function(){});
    }
    checkAnnouncement();
    setInterval(checkAnnouncement, 10000);

    // Update dismiss to store ts
    window.dismissAnnouncement = function() {
        fetch(FBURL_OWNER + '/announcement.json').then(function(r){ return r.json(); }).then(function(d) {
            if (d && d.ts) sessionStorage.setItem('ann_dismissed_' + d.ts, '1');
        }).catch(function(){});
        hideBanner();
    };

    // ===== CHAT CLEAR =====
    window.ownerClearChat = function() {
        if (!confirm('Clear all chat messages?')) return;
        fetch(FBURL_OWNER + '/chat/messages.json', { method: 'DELETE' }).then(function() {
            fetch(FBURL_OWNER + '/chat/messages.json', {
                method: 'POST',
                body: JSON.stringify({ type:'system', name:'System', text:'Owner cleared the chat.', userId:'system', ts: Date.now() })
            });
            var box = document.getElementById('chatMessages');
            if (box) box.innerHTML = '';
            if (window.renderedKeys) window.renderedKeys.clear();
            loadChatCount();
        }).catch(function(){});
    };

    function loadChatCount() {
        fetch(FBURL_OWNER + '/chat/messages.json').then(function(r){ return r.json(); }).then(function(d) {
            var count = d ? Object.keys(d).length : 0;
            var el = document.getElementById('chatMsgCount');
            if (el) el.textContent = '💬 Messages: ' + count + ' / 60';
        }).catch(function(){});
    }

    // ===== USER BAN SYSTEM =====
    var bannedUsers = JSON.parse(localStorage.getItem('banned_users') || '[]');

    function loadOnlineUsers() {
        var list = document.getElementById('onlineUsersList');
        if (!list) return;
        list.innerHTML = '<div style="color:rgba(255,255,255,0.4);font-size:0.8rem;">Loading...</div>';

        fetch(FBURL_OWNER + '/chat/presence.json').then(function(r){ return r.json(); }).then(function(d) {
            if (!d || Object.keys(d).length === 0) {
                list.innerHTML = '<div style="color:rgba(255,255,255,0.4);font-size:0.8rem;">No users online</div>';
                return;
            }
            list.innerHTML = '';
            Object.entries(d).forEach(function(entry) {
                var uid = entry[0];
                var info = entry[1];
                var isBanned = bannedUsers.includes(uid);
                var item = document.createElement('div');
                item.className = 'user-ban-item';
                var safeName = (info.name||'User').replace(/'/g,'&apos;');
                item.innerHTML = '<span class="user-name-lbl">' + (isBanned ? '🚫 ' : '🟢 ') + (info.name || uid) + '</span>' +
                    (isBanned
                        ? '<button class="unban-btn" onclick="unbanUser(\'' + uid + '\')">✅ Unban</button>'
                        : '<button class="ban-btn" onclick="banUser(\'' + uid + '\',\'' + safeName + '\')">🚫 Ban</button>');
                list.appendChild(item);
            });
        }).catch(function() {
            list.innerHTML = '<div style="color:rgba(255,255,255,0.4);font-size:0.8rem;">Failed to load</div>';
        });
    }

    window.banUser = function(uid, name) {
        if (!bannedUsers.includes(uid)) {
            bannedUsers.push(uid);
            localStorage.setItem('banned_users', JSON.stringify(bannedUsers));
        }
        var banData = { name: name, ts: Date.now() };
        // Store ban in Firebase - main ID
        fetch(FBURL_OWNER + '/chat/banned/' + uid + '.json', {
            method: 'PUT',
            body: JSON.stringify(banData)
        }).then(function() {
            // Remove from presence (kick)
            fetch(FBURL_OWNER + '/chat/presence/' + uid + '.json', { method: 'DELETE' });
            // Send system msg
            fetch(FBURL_OWNER + '/chat/messages.json', {
                method: 'POST',
                body: JSON.stringify({ type:'system', name:'System', text: name + ' has been banned. 🚫', userId:'system', ts: Date.now() })
            });
            loadOnlineUsers();
        }).catch(function(){});

        // ✅ FIX: Also store presence data fingerprint if available
        // Presence record eke fp field ekak tiboth eka wath ban karamu
        fetch(FBURL_OWNER + '/chat/presence/' + uid + '.json')
            .then(function(r){ return r.json(); })
            .then(function(presData) {
                if (presData && presData.fp) {
                    fetch(FBURL_OWNER + '/chat/banned/' + presData.fp + '.json', {
                        method: 'PUT',
                        body: JSON.stringify({ name: name, ts: Date.now(), fp: true })
                    }).catch(function(){});
                }
            }).catch(function(){});
    };

    window.unbanUser = function(uid) {
        bannedUsers = bannedUsers.filter(function(id){ return id !== uid; });
        localStorage.setItem('banned_users', JSON.stringify(bannedUsers));
        fetch(FBURL_OWNER + '/chat/banned/' + uid + '.json', { method: 'DELETE' })
            .then(function(){ loadOnlineUsers(); }).catch(function(){});
    };

    // Check if current user is banned
    // ===== UNBYPASSABLE BAN SYSTEM =====
    var _banActive = false;

    // Generate device fingerprint (localStorage clear කළාත් හොයාගනිමු)
    function _getFingerprint() {
        var nav = navigator;
        var fp = [
            nav.userAgent,
            nav.language,
            screen.width + 'x' + screen.height,
            screen.colorDepth,
            new Date().getTimezoneOffset(),
            nav.hardwareConcurrency || 0,
            nav.platform || ''
        ].join('|');
        // Simple hash of fingerprint
        var h = 0;
        for (var i = 0; i < fp.length; i++) {
            h = ((h << 5) - h) + fp.charCodeAt(i);
            h = h & h;
        }
        return 'fp_' + Math.abs(h).toString(36);
    }

    // Get all possible IDs this user might have
    function _getAllIds() {
        var ids = [];
        // Normal localStorage ID
        var mainId = localStorage.getItem('chat_my_id');
        if (mainId) ids.push(mainId);
        // sessionStorage ID (incognito mode)
        var sessId = sessionStorage.getItem('chat_my_id');
        if (sessId && sessId !== mainId) ids.push(sessId);
        // Device fingerprint (works even in incognito)
        var fp = _getFingerprint();
        ids.push(fp);
        return ids;
    }

    // ✅ FIX 2: Incognito mode - chat_my_id sessionStorage eke wath save karamu
    // Normal mode: localStorage
    // Incognito mode: sessionStorage also saved
    (function() {
        var existingId = localStorage.getItem('chat_my_id');
        if (existingId) {
            // Save to sessionStorage too so incognito can be tracked via fingerprint
            sessionStorage.setItem('chat_my_id', existingId);
        }
    })();

    function _lockPage() {
        // ✅ Final safety check - owner nam lock nenne na
        if (sessionStorage.getItem(atob("X293X29r")) === '1') return;
        _banActive = true;

        // 1. Destroy all page content & functionality
        document.body.style.overflow = 'hidden';
        document.body.style.pointerEvents = 'none';

        // 2. Create unremovable overlay
        var old = document.getElementById('_banWall');
        if (old) old.remove();

        var wall = document.createElement('div');
        wall.id = '_banWall';
        wall.style.cssText = [
            'position:fixed',
            'top:0','left:0',
            'width:100vw','height:100vh',
            'background:#fff',
            'z-index:2147483647',
            'display:flex',
            'flex-direction:column',
            'align-items:center',
            'justify-content:center',
            'text-align:center',
            'padding:30px',
            'pointer-events:all'
        ].join(';');

        wall.innerHTML = '<div style="max-width:480px;width:100%;font-family:Segoe UI,sans-serif;">'
            + '<div style="font-size:5rem;margin-bottom:16px;">🚫</div>'
            + '<h1 style="font-size:1.8rem;color:#cc0000;margin-bottom:12px;">ඔයාව site එකෙන් Owner Block කරලා 😔</h1>'
            + '<p style="color:#444;font-size:1rem;margin-bottom:6px;">Unblock කරගන්න ඕනේ නම් Owner ට message එකක් දාන්න.</p>'
            + '<a href="https://wa.me/94742323368" target="_blank" style="display:inline-block;margin:12px 0 20px;background:#25D366;color:#fff;padding:12px 28px;border-radius:30px;text-decoration:none;font-size:1rem;font-weight:bold;">📱 WhatsApp: +94 742323368</a>'
            + '<hr style="border:none;border-top:1.5px solid #ddd;margin:16px 0;">'
            + '<h2 style="font-size:1.3rem;color:#cc0000;margin-bottom:10px;">You have been blocked by the owner 😔</h2>'
            + '<p style="color:#444;font-size:0.95rem;margin-bottom:6px;">If you want to unblock, send a message to the owner.</p>'
            + '<a href="https://wa.me/94742323368" target="_blank" style="display:inline-block;margin:12px 0 0;background:#25D366;color:#fff;padding:12px 28px;border-radius:30px;text-decoration:none;font-size:1rem;font-weight:bold;">📱 WhatsApp: +94 742323368</a>'
            + '</div>';

        document.documentElement.appendChild(wall);

        // 3. MutationObserver - overlay remove කළාත් නැවත add කරනවා
        var obs = new MutationObserver(function(mutations) {
            if (_banActive) {
                var el = document.getElementById('_banWall');
                if (!el || !document.documentElement.contains(el)) {
                    document.documentElement.appendChild(wall);
                }
                // Style tamper detection
                if (wall.style.display === 'none' || wall.style.visibility === 'hidden' || wall.style.opacity === '0') {
                    wall.style.display = 'flex';
                    wall.style.visibility = 'visible';
                    wall.style.opacity = '1';
                }
            }
        });
        obs.observe(document.documentElement, { childList: true, subtree: true, attributes: true, attributeFilter: ['style','class'] });

        // 4. Block all keyboard shortcuts (F12, Ctrl+Shift+I, etc.)
        document.addEventListener('keydown', function(e) {
            if (_banActive) {
                e.preventDefault();
                e.stopImmediatePropagation();
                return false;
            }
        }, true);

        // 5. Block right click
        document.addEventListener('contextmenu', function(e) {
            if (_banActive) { e.preventDefault(); return false; }
        }, true);

        // 6. Continuous re-lock every 500ms (bypass proof)
        setInterval(function() {
            if (_banActive) {
                var el = document.getElementById('_banWall');
                if (!el) { document.documentElement.appendChild(wall); }
                else {
                    el.style.display = 'flex';
                    el.style.zIndex = '2147483647';
                    el.style.visibility = 'visible';
                    el.style.opacity = '1';
                }
                document.body.style.overflow = 'hidden';
            }
        }, 500);

        // 7. Store ban in multiple storage locations
        try { localStorage.setItem(atob("X3NpdGVfYmFubmVk"), '1'); } catch(e){}
        try { sessionStorage.setItem(atob("X3NpdGVfYmFubmVk"), '1'); } catch(e){}
    }

    function checkIfBanned() {
        // ✅ FIX 1: Owner logged in නම් ban check skip කරනවා
        if (sessionStorage.getItem(atob("X293X29r")) === '1') return;

        var ids = _getAllIds();
        ids.forEach(function(id) {
            fetch(FBURL_OWNER + '/chat/banned/' + id + '.json')
                .then(function(r){ return r.json(); })
                .then(function(d) {
                    if (d && d.ts) {
                        // ✅ Double check - owner session check again before locking
                        if (sessionStorage.getItem(atob("X293X29r")) === '1') return;
                        _lockPage();
                        // Store fingerprint ban in Firebase
                        var fp = _getFingerprint();
                        if (id !== fp) {
                            fetch(FBURL_OWNER + '/chat/banned/' + fp + '.json', {
                                method: 'PUT',
                                body: JSON.stringify({ name: d.name || 'banned', ts: d.ts, fp: true })
                            }).catch(function(){});
                        }
                    }
                }).catch(function(){});
        });
    }

    // Check on load immediately
    checkIfBanned();
    // Re-check every 5 seconds (faster - harder to bypass timing)
    setInterval(checkIfBanned, 5000);

    // Also check if previously flagged in storage (skip if owner)
    if (sessionStorage.getItem(atob("X293X29r")) !== '1') {
        if (localStorage.getItem(atob("X3NpdGVfYmFubmVk")) === '1' || sessionStorage.getItem(atob("X3NpdGVfYmFubmVk")) === '1') {
            checkIfBanned();
        }
    }

    // ===== LIVE VISITORS =====
    function loadVisitors() {
        var list = document.getElementById('visitorsList');
        if (!list) return;
        list.innerHTML = '<div style="color:rgba(255,255,255,0.4);font-size:0.8rem;">Loading...</div>';

        // Get presence data (online users)
        fetch(FBURL_OWNER + '/chat/presence.json').then(function(r){ return r.json(); }).then(function(d) {
            var users = d ? Object.entries(d) : [];
            list.innerHTML = '';

            if (users.length === 0) {
                list.innerHTML = '<div style="color:rgba(255,255,255,0.4);font-size:0.8rem;">No visitors online</div>';
                return;
            }

            // Get location via free API
            fetch('https://ipapi.co/json/').then(function(r){ return r.json(); }).then(function(loc) {
                var country = loc.country_name || 'Unknown';
                var city = loc.city || '';
                var flag = loc.country_code ? getFlag(loc.country_code) : '🌍';

                users.forEach(function(entry, i) {
                    var info = entry[1];
                    var item = document.createElement('div');
                    item.className = 'visitor-item';
                    // Show location for current user, unknown for others
                    var loc_txt = i === 0 ? (flag + ' ' + city + ', ' + country) : '🌍 Unknown';
                    item.innerHTML = '<span>👤</span><span style="flex:1">' + (info.name||'Visitor') + '</span><span style="font-size:0.72rem;opacity:0.6">' + loc_txt + '</span>';
                    list.appendChild(item);
                });
            }).catch(function() {
                users.forEach(function(entry) {
                    var info = entry[1];
                    var item = document.createElement('div');
                    item.className = 'visitor-item';
                    item.innerHTML = '<span>👤</span><span>' + (info.name||'Visitor') + '</span><span style="font-size:0.72rem;opacity:0.6;margin-left:auto">🌍 Online</span>';
                    list.appendChild(item);
                });
            });
        }).catch(function() {
            list.innerHTML = '<div style="color:rgba(255,255,255,0.4);font-size:0.8rem;">Failed to load</div>';
        });
    }

    function getFlag(code) {
        return code.toUpperCase().replace(/./g, function(c) {
            return String.fromCodePoint(0x1F1E0 + c.charCodeAt(0) - 65);
        });
    }
    </script>

</body>
</html>
